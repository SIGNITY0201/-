<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TERRACASA ê²¬ì  ì‹œìŠ¤í…œ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <style>
        /* Custom Colors */
        .text-tc-olive { color: #4A5D23; }
        .bg-tc-olive { background-color: #4A5D23; }
        .ring-tc-olive { --tw-ring-color: #4A5D23; }
        .border-tc-olive { border-color: #4A5D23; }
        .accent-tc-olive { accent-color: #4A5D23; }
        
        /* Print Styles */
        @media print {
            body > * { display: none !important; }
            #modal-root, #modal-root * { display: block !important; visibility: visible !important; }
            #modal-root { position: absolute !important; inset: 0 !important; background: white !important; width: 100% !important; height: auto !important; z-index: 9999; }
            #print-area { 
                box-shadow: none !important; 
                max-width: 100% !important; 
                width: 100% !important; 
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
                position: absolute;
                top: 0;
                left: 0;
            }
            .print-hidden { display: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }

        /* Animations */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin { animation: spin 1s linear infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans flex items-center justify-center p-4">

    <!-- App Root -->
    <div id="app" class="bg-white w-full max-w-xl rounded-2xl shadow-xl overflow-hidden min-h-[600px] flex flex-col relative">
        <!-- Dynamic Content Will Be Rendered Here -->
    </div>

    <!-- Modal Root -->
    <div id="modal-root" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <!-- Modal Content Will Be Rendered Here -->
    </div>

    <script type="module">
        // ==================================================================================
        // [ì„¤ì •] Firebase Imports & Initialization
        // ==================================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Global Variable Access (Canvas Environment)
        const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify({ apiKey: "dummy", authDomain: "dummy", projectId: "dummy" }); // Fallback for safety
        const appIdStr = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db;
        
        try {
            const firebaseConfig = JSON.parse(firebaseConfigStr);
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        // ==================================================================================
        // [ì„¤ì •] EmailJS
        // ==================================================================================
        const EMAILJS_SERVICE_ID = "service_r3nil9k";   
        const EMAILJS_TEMPLATE_ID = "template_2lqnkam"; 
        const EMAILJS_PUBLIC_KEY = "uqikvD1GCoxfF_h69";   
        let emailJsReady = false;

        // ==================================================================================
        // [ë°ì´í„°] ê°€ê²©í‘œ & ì§€ì—­ ë°ì´í„°
        // ==================================================================================
        const oasisManualPriceTable = {
            2600: [3200000, 3400000, 3600000, 3800000, 4000000, 4200000, 4400000],
            2775: [3240000, 3450000, 3660000, 3870000, 4080000, 4290000, 4500000],
            2950: [3280000, 3500000, 3720000, 3940000, 4160000, 4380000, 4600000],
            3125: [3320000, 3550000, 3780000, 4010000, 4240000, 4470000, 4700000],
            3300: [3360000, 3600000, 3840000, 4080000, 4320000, 4560000, 4800000],
            3475: [3400000, 3650000, 3900000, 4150000, 4400000, 4650000, 4900000],
            3650: [3440000, 3700000, 3960000, 4220000, 4480000, 4740000, 5000000],
            3825: [3480000, 3750000, 4020000, 4290000, 4560000, 4830000, 5100000],
            4000: [3520000, 3800000, 4080000, 4360000, 4640000, 4920000, 5200000],
            4175: [3560000, 3850000, 4140000, 4430000, 4720000, 5010000, 5300000],
            4350: [3600000, 3900000, 4200000, 4500000, 4800000, 5100000, 5400000],
            4525: [3640000, 3950000, 4260000, 4570000, 4880000, 5190000, 5500000],
            4700: [3680000, 4000000, 4320000, 4640000, 4960000, 5280000, 5600000],
            4875: [3720000, 4050000, 4380000, 4710000, 5040000, 5370000, 5700000],
            5050: [3760000, 4100000, 4440000, 4780000, 5120000, 5460000, 5800000],
            5225: [3800000, 4150000, 4500000, 4850000, 5200000, 5550000, 5900000],
            5400: [3840000, 4200000, 4560000, 4920000, 5280000, 5640000, 6000000],
            5575: [3880000, 4250000, 4620000, 4990000, 5360000, 5730000, 6100000],
            5750: [3920000, 4300000, 4680000, 5060000, 5440000, 5820000, 6200000],
            5925: [3960000, 4350000, 4740000, 5130000, 5520000, 5910000, 6300000]
        };

        const oasisElectricPriceTable = {
            2600: [3600000, 3850000, 4100000, 4350000, 4600000, 4850000, 5100000],
            2775: [3640000, 3900000, 4160000, 4420000, 4680000, 4940000, 5200000],
            2950: [3680000, 3950000, 4220000, 4490000, 4760000, 5030000, 5300000],
            3125: [3720000, 4000000, 4280000, 4560000, 4840000, 5120000, 5400000],
            3300: [3760000, 4050000, 4340000, 4630000, 4920000, 5210000, 5500000],
            3475: [3800000, 4100000, 4400000, 4700000, 5000000, 5300000, 5600000],
            3650: [3840000, 4150000, 4460000, 4770000, 5080000, 5390000, 5700000],
            3825: [3880000, 4200000, 4520000, 4840000, 5160000, 5480000, 5800000],
            4000: [3920000, 4250000, 4580000, 4910000, 5240000, 5570000, 5900000],
            4175: [3960000, 4300000, 4640000, 4980000, 5320000, 5660000, 6000000],
            4350: [4000000, 4350000, 4700000, 5050000, 5400000, 5750000, 6100000],
            4525: [4040000, 4400000, 4760000, 5120000, 5480000, 5840000, 6200000],
            4700: [4080000, 4450000, 4820000, 5190000, 5560000, 5930000, 6300000],
            4875: [4120000, 4500000, 4880000, 5260000, 5640000, 6020000, 6400000],
            5050: [4160000, 4550000, 4940000, 5330000, 5720000, 6110000, 6500000],
            5225: [4200000, 4600000, 5000000, 5400000, 5800000, 6200000, 6600000],
            5400: [4240000, 4650000, 5060000, 5470000, 5880000, 6290000, 6700000],
            5575: [4280000, 4700000, 5120000, 5540000, 5960000, 6380000, 6800000],
            5750: [4320000, 4750000, 5180000, 5610000, 6040000, 6470000, 6900000],
            5925: [4360000, 4800000, 5240000, 5680000, 6120000, 6560000, 7000000]
        };

        const regions = {
            'ì„œìš¸íŠ¹ë³„ì‹œ': ['ê°•ë‚¨êµ¬', 'ê°•ë™êµ¬', 'ê°•ë¶êµ¬', 'ê°•ì„œêµ¬', 'ê´€ì•…êµ¬', 'ê´‘ì§„êµ¬', 'êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬', 'ë…¸ì›êµ¬', 'ë„ë´‰êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ë™ì‘êµ¬', 'ë§ˆí¬êµ¬', 'ì„œëŒ€ë¬¸êµ¬', 'ì„œì´ˆêµ¬', 'ì„±ë™êµ¬', 'ì„±ë¶êµ¬', 'ì†¡íŒŒêµ¬', 'ì–‘ì²œêµ¬', 'ì˜ë“±í¬êµ¬', 'ìš©ì‚°êµ¬', 'ì€í‰êµ¬', 'ì¢…ë¡œêµ¬', 'ì¤‘êµ¬', 'ì¤‘ë‘êµ¬'],
            'ë¶€ì‚°ê´‘ì—­ì‹œ': ['ê°•ì„œêµ¬', 'ê¸ˆì •êµ¬', 'ê¸°ì¥êµ°', 'ë‚¨êµ¬', 'ë™êµ¬', 'ë™ë˜êµ¬', 'ë¶€ì‚°ì§„êµ¬', 'ë¶êµ¬', 'ì‚¬ìƒêµ¬', 'ì‚¬í•˜êµ¬', 'ì„œêµ¬', 'ìˆ˜ì˜êµ¬', 'ì—°ì œêµ¬', 'ì˜ë„êµ¬', 'ì¤‘êµ¬', 'í•´ìš´ëŒ€êµ¬'],
            'ëŒ€êµ¬ê´‘ì—­ì‹œ': ['êµ°ìœ„êµ°', 'ë‚¨êµ¬', 'ë‹¬ì„œêµ¬', 'ë‹¬ì„±êµ°', 'ë™êµ¬', 'ë¶êµ¬', 'ì„œêµ¬', 'ìˆ˜ì„±êµ¬', 'ì¤‘êµ¬'],
            'ì¸ì²œê´‘ì—­ì‹œ': ['ê°•í™”êµ°', 'ê³„ì–‘êµ¬', 'ë‚¨ë™êµ¬', 'ë™êµ¬', 'ë¯¸ì¶”í™€êµ¬', 'ë¶€í‰êµ¬', 'ì„œêµ¬', 'ì—°ìˆ˜êµ¬', 'ì˜¹ì§„êµ°', 'ì¤‘êµ¬'],
            'ê´‘ì£¼ê´‘ì—­ì‹œ': ['ê´‘ì‚°êµ¬', 'ë‚¨êµ¬', 'ë™êµ¬', 'ë¶êµ¬', 'ì„œêµ¬'],
            'ëŒ€ì „ê´‘ì—­ì‹œ': ['ëŒ€ë•êµ¬', 'ë™êµ¬', 'ì„œêµ¬', 'ìœ ì„±êµ¬', 'ì¤‘êµ¬'],
            'ìš¸ì‚°ê´‘ì—­ì‹œ': ['ë‚¨êµ¬', 'ë™êµ¬', 'ë¶êµ¬', 'ìš¸ì£¼êµ°', 'ì¤‘êµ¬'],
            'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ': ['ì„¸ì¢…ì‹œ'],
            'ê²½ê¸°ë„': ['ê°€í‰êµ°', 'ê³ ì–‘ì‹œ', 'ê³¼ì²œì‹œ', 'ê´‘ëª…ì‹œ', 'ê´‘ì£¼ì‹œ', 'êµ¬ë¦¬ì‹œ', 'êµ°í¬ì‹œ', 'ê¹€í¬ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ', 'ë™ë‘ì²œì‹œ', 'ë¶€ì²œì‹œ', 'ì„±ë‚¨ì‹œ', 'ìˆ˜ì›ì‹œ', 'ì‹œí¥ì‹œ', 'ì•ˆì‚°ì‹œ', 'ì•ˆì„±ì‹œ', 'ì•ˆì–‘ì‹œ', 'ì–‘ì£¼ì‹œ', 'ì–‘í‰êµ°', 'ì—¬ì£¼ì‹œ', 'ì—°ì²œêµ°', 'ì˜¤ì‚°ì‹œ', 'ìš©ì¸ì‹œ', 'ì˜ì™•ì‹œ', 'ì˜ì •ë¶€ì‹œ', 'ì´ì²œì‹œ', 'íŒŒì£¼ì‹œ', 'í‰íƒì‹œ', 'í¬ì²œì‹œ', 'í•˜ë‚¨ì‹œ', 'í™”ì„±ì‹œ'],
            'ê°•ì›íŠ¹ë³„ìì¹˜ë„': ['ê°•ë¦‰ì‹œ', 'ê³ ì„±êµ°', 'ë™í•´ì‹œ', 'ì‚¼ì²™ì‹œ', 'ì†ì´ˆì‹œ', 'ì–‘êµ¬êµ°', 'ì–‘ì–‘êµ°', 'ì˜ì›”êµ°', 'ì›ì£¼ì‹œ', 'ì¸ì œêµ°', 'ì •ì„ êµ°', 'ì² ì›êµ°', 'ì¶˜ì²œì‹œ', 'íƒœë°±ì‹œ', 'í‰ì°½êµ°', 'í™ì²œêµ°', 'í™”ì²œêµ°', 'íš¡ì„±êµ°'],
            'ì¶©ì²­ë¶ë„': ['ê´´ì‚°êµ°', 'ë‹¨ì–‘êµ°', 'ë³´ì€êµ°', 'ì˜ë™êµ°', 'ì˜¥ì²œêµ°', 'ìŒì„±êµ°', 'ì œì²œì‹œ', 'ì¦í‰êµ°', 'ì§„ì²œêµ°', 'ì²­ì£¼ì‹œ', 'ì¶©ì£¼ì‹œ'],
            'ì¶©ì²­ë‚¨ë„': ['ê³„ë£¡ì‹œ', 'ê³µì£¼ì‹œ', 'ê¸ˆì‚°êµ°', 'ë…¼ì‚°ì‹œ', 'ë‹¹ì§„ì‹œ', 'ë³´ë ¹ì‹œ', 'ë¶€ì—¬êµ°', 'ì„œì‚°ì‹œ', 'ì„œì²œêµ°', 'ì•„ì‚°ì‹œ', 'ì˜ˆì‚°êµ°', 'ì²œì•ˆì‹œ', 'ì²­ì–‘êµ°', 'íƒœì•ˆêµ°', 'í™ì„±êµ°'],
            'ì „ë¶íŠ¹ë³„ìì¹˜ë„': ['ê³ ì°½êµ°', 'êµ°ì‚°ì‹œ', 'ê¹€ì œì‹œ', 'ë‚¨ì›ì‹œ', 'ë¬´ì£¼êµ°', 'ë¶€ì•ˆêµ°', 'ìˆœì°½êµ°', 'ì™„ì£¼êµ°', 'ìµì‚°ì‹œ', 'ì„ì‹¤êµ°', 'ì¥ìˆ˜êµ°', 'ì „ì£¼ì‹œ', 'ì •ìì‹œ', 'ì§„ì•ˆêµ°'],
            'ì „ë¼ë‚¨ë„': ['ê°•ì§„êµ°', 'ê³ í¥êµ°', 'ê³¡ì„±êµ°', 'ê´‘ì–‘ì‹œ', 'êµ¬ë¡€êµ°', 'ë‚˜ì£¼ì‹œ', 'ë‹´ì–‘êµ°', 'ëª©í¬ì‹œ', 'ë¬´ì•ˆêµ°', 'ë³´ì„±êµ°', 'ìˆœì²œì‹œ', 'ì‹ ì•ˆêµ°', 'ì—¬ìˆ˜ì‹œ', 'ì˜ê´‘êµ°', 'ì˜ì•”êµ°', 'ì™„ë„êµ°', 'ì¥ì„±êµ°', 'ì¥í¥êµ°', 'ì§„ë„êµ°', 'í•¨í‰êµ°', 'í•´ë‚¨êµ°', 'í™”ìˆœêµ°'],
            'ê²½ìƒë¶ë„': ['ê²½ì‚°ì‹œ', 'ê²½ì£¼ì‹œ', 'ê³ ë ¹êµ°', 'êµ¬ë¯¸ì‹œ', 'ê¹€ì²œì‹œ', 'ë¬¸ê²½ì‹œ', 'ë´‰í™”êµ°', 'ìƒì£¼ì‹œ', 'ì„±ì£¼êµ°', 'ì•ˆë™ì‹œ', 'ì˜ë•êµ°', 'ì˜ì–‘êµ°', 'ì˜ì£¼ì‹œ', 'ì˜ì²œì‹œ', 'ì˜ˆì²œêµ°', 'ìš¸ë¦‰êµ°', 'ìš¸ì§„êµ°', 'ì˜ì„±êµ°', 'ì²­ë„êµ°', 'ì²­ì†¡êµ°', 'ì¹ ê³¡êµ°', 'í¬í•­ì‹œ'],
            'ê²½ìƒë‚¨ë„': ['ê±°ì œì‹œ', 'ê±°ì°½êµ°', 'ê³ ì„±êµ°', 'ê¹€í•´ì‹œ', 'ë‚¨í•´êµ°', 'ë°€ì–‘ì‹œ', 'ì‚¬ì²œì‹œ', 'ì‚°ì²­êµ°', 'ì–‘ì‚°ì‹œ', 'ì˜ë ¹êµ°', 'ì§„ì£¼ì‹œ', 'ì°½ë…•êµ°', 'ì°½ì›ì‹œ', 'í†µì˜ì‹œ', 'í•˜ë™êµ°', 'í•¨ì•ˆêµ°', 'í•¨ì–‘êµ°', 'í•©ì²œêµ°'],
            'ì œì£¼íŠ¹ë³„ìì¹˜ë„': ['ì„œê·€í¬ì‹œ', 'ì œì£¼ì‹œ']
        };

        // ==================================================================================
        // [State Management]
        // ==================================================================================
        const state = {
            step: 1,
            loading: false,
            errorMsg: "",
            result: null,
            user: null,
            formData: {
                phone: '',
                regionDo: '',
                regionSi: '',
                userType: '',
                timeline: '',
                liftingType: '',
                operationType: '',
                width: '', 
                projection: '', 
                height: '3000',
                measurementNeed: 'approx',
                optionLed: false,
                optionGlass: '',
                optionDeck: false,
            }
        };

        // ==================================================================================
        // [Initialization]
        // ==================================================================================
        async function init() {
            // 1. EmailJS Init
            if (window.emailjs) {
                window.emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });
                emailJsReady = true;
                console.log("EmailJS Ready");
            } else {
                console.error("EmailJS SDK failed to load");
            }

            // 2. Firebase Auth Init
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                onAuthStateChanged(auth, (user) => {
                    state.user = user;
                });
            } catch (e) {
                console.log("Auth init skipped or failed", e);
            }

            render();
        }

        // ==================================================================================
        // [Rendering Logic]
        // ==================================================================================
        const appEl = document.getElementById('app');
        const modalEl = document.getElementById('modal-root');

        function render() {
            // Render Main App
            appEl.innerHTML = `
                ${renderHeader()}
                <div class="w-full h-1 bg-gray-100">
                    <div class="h-full bg-tc-olive transition-all duration-300 ease-out" style="width: ${(state.step / 6) * 100}%"></div>
                </div>
                <div class="flex-1 p-6 md:p-8 overflow-y-auto">
                    ${renderStep()}
                </div>
                ${renderFooter()}
            `;

            // Render Modal
            if (state.result) {
                modalEl.classList.remove('hidden');
                modalEl.innerHTML = renderResultModal();
            } else {
                modalEl.classList.add('hidden');
                modalEl.innerHTML = '';
            }

            // Initialize Icons
            lucide.createIcons();

            // Attach Event Listeners
            attachEventListeners();
        }

        function renderHeader() {
            return `
                <div class="bg-white border-b p-4 flex justify-between items-center">
                    <h1 class="text-lg font-extrabold text-tc-olive tracking-wide">TERRACASA ESTIMATE</h1>
                    <div class="text-xs font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded">Step ${state.step} / 6</div>
                </div>
            `;
        }

        function renderFooter() {
            return `
                <div class="p-4 bg-white border-t space-y-3">
                    <div class="flex gap-3">
                        ${state.step > 1 ? `
                            <button id="btn-prev" class="flex-1 py-3 rounded-xl border border-gray-300 font-bold text-gray-500 hover:bg-gray-50 transition">
                                ì´ì „
                            </button>
                        ` : ''}
                        
                        ${state.step < 6 ? `
                            <button id="btn-next" class="flex-1 py-3 rounded-xl bg-tc-olive text-white font-bold text-lg hover:bg-opacity-90 transition flex justify-center items-center gap-2">
                                ë‹¤ìŒ <i data-lucide="chevron-right" width="20"></i>
                            </button>
                        ` : `
                            <button id="btn-calc" ${state.loading ? 'disabled' : ''} class="flex-1 py-3 rounded-xl bg-tc-olive text-white font-bold text-lg hover:bg-opacity-90 transition flex justify-center items-center gap-2 disabled:bg-gray-400">
                                ${state.loading ? 'ì „ì†¡ì¤‘...' : 'ê²¬ì  í™•ì¸í•˜ê¸°'} 
                                ${state.loading ? '<i data-lucide="send" class="animate-spin" width="20"></i>' : '<i data-lucide="calculator" width="20"></i>'}
                            </button>
                        `}
                    </div>
                </div>
            `;
        }

        function renderStep() {
            switch(state.step) {
                case 1: return renderStep1();
                case 2: return renderStep2();
                case 3: return renderStep3();
                case 4: return renderStep4();
                case 5: return renderStep5();
                case 6: return renderStep6();
                default: return '';
            }
        }

        // --- Step Components ---

        function renderStep1() {
            const siOptions = state.formData.regionDo ? regions[state.formData.regionDo].map(s => `<option value="${s}" ${state.formData.regionSi === s ? 'selected' : ''}>${s}</option>`).join('') : '';
            
            return `
                <div class="space-y-6">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="phone" class="w-6 h-6 text-tc-olive"></i> ê¸°ë³¸ ì •ë³´ ì…ë ¥
                    </h2>
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r">
                        <div class="flex items-start">
                            <i data-lucide="alert-triangle" class="h-5 w-5 text-yellow-600 mr-2 mt-0.5"></i>
                            <p class="text-sm text-yellow-700 font-bold">
                                ì•ˆë‚´: íƒ€ì¸ì˜ ì „í™”ë²ˆí˜¸ë¥¼ ë„ìš©í•˜ì—¬ ê²¬ì ì„ ì‚°ì¶œí•  ê²½ìš° ë²•ì ì¸ ì±…ì„ì´ ë”°ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°˜ë“œì‹œ ë³¸ì¸ì˜ íœ´ëŒ€ì „í™” ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
                            </p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">íœ´ëŒ€í° ë²ˆí˜¸</label>
                        <input type="tel" id="input-phone" value="${state.formData.phone}" placeholder="010-0000-0000" maxlength="13" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tc-olive focus:border-transparent outline-none transition">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ì‹œ/ë„</label>
                            <select id="select-do" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tc-olive outline-none bg-white">
                                <option value="">ì„ íƒ</option>
                                ${Object.keys(regions).map(r => `<option value="${r}" ${state.formData.regionDo === r ? 'selected' : ''}>${r}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ì‹œ/êµ°/êµ¬</label>
                            <select id="select-si" ${!state.formData.regionDo ? 'disabled' : ''} class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tc-olive outline-none bg-white disabled:bg-gray-100">
                                <option value="">ì„ íƒ</option>
                                ${siOptions}
                            </select>
                        </div>
                    </div>
                    ${renderErrorMsg()}
                </div>
            `;
        }

        function renderStep2() {
            const types = ['ê°œì¸ ê³ ê°', 'ì¸í…Œë¦¬ì–´ ì—…ì²´', 'ì¡°ê²½ ì—…ì²´', 'ê±´ì¶•/ì„¤ê³„ì‚¬', 'ê´€ê³µì„œ/ê¸°ì—…'];
            return `
                <div class="space-y-6">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="user" class="w-6 h-6 text-tc-olive"></i> ê³ ê° êµ¬ë¶„
                    </h2>
                    <p class="text-sm text-gray-500">ì •í™•í•œ ìƒë‹´ ë°°ì •ì„ ìœ„í•´ ê³ ê° ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${types.map(type => `
                            <button onclick="window.handleAutoNext('userType', '${type}')" class="p-4 rounded-xl border-2 text-left transition-all ${state.formData.userType === type ? 'border-tc-olive bg-green-50 text-tc-olive font-bold shadow-md' : 'border-gray-200 hover:border-tc-olive hover:bg-gray-50'}">
                                ${type}
                            </button>
                        `).join('')}
                    </div>
                    ${renderErrorMsg()}
                </div>
            `;
        }

        function renderStep3() {
            const options = [
                { label: '1ê°œì›” ì´ë‚´ (ê¸´ê¸‰)', val: 'urgent' },
                { label: '3ê°œì›” ì´ë‚´ (ë³´í†µ)', val: 'normal' },
                { label: '6ê°œì›” ì´ë‚´ (ì—¬ìœ )', val: 'relaxed' },
                { label: '6ê°œì›” ì´í›„ / ê³„íšë‹¨ê³„', val: 'planning' }
            ];
            return `
                <div class="space-y-6">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="calendar" class="w-6 h-6 text-tc-olive"></i> ì‹œê³µ ì˜ˆì • ì‹œê¸°
                    </h2>
                    <div class="grid grid-cols-1 gap-3">
                        ${options.map(item => `
                            <button onclick="window.handleAutoNext('timeline', '${item.val}')" class="p-4 rounded-xl border-2 text-left transition-all ${state.formData.timeline === item.val ? 'border-tc-olive bg-green-50 text-tc-olive font-bold shadow-md' : 'border-gray-200 hover:border-tc-olive hover:bg-gray-50'}">
                                ${item.label}
                            </button>
                        `).join('')}
                    </div>
                    ${renderErrorMsg()}
                </div>
            `;
        }

        function renderStep4() {
            const liftingOptions = [
                { label: 'ì¦‰ì‹œ ì§„ì… ê°€ëŠ¥', desc: '1ì¸µ / í™”ë¬¼ì°¨ í•˜ì°¨ í›„ ì¦‰ì‹œ ì§„ì…', val: 'direct_entry', icon: 'arrow-right-from-line' },
                { label: 'ì‚¬ë‹¤ë¦¬ì°¨ ì‚¬ìš©', desc: '1ì¸µ ì´ìƒ / ì§„ì…ë¡œ í˜‘ì†Œ', val: 'ladder', icon: 'arrow-up-to-line' },
                { label: 'í¬ë ˆì¸ ì‚¬ìš©', desc: 'ê³ ì¸µ / ëŒ€í˜• ì¥ë¹„ í•„ìš”', val: 'crane', icon: 'construction' },
                { label: 'ìì¬ ì†Œìš´ë°˜ (20m+)', desc: 'í•˜ì°¨ í›„ 20m ì´ìƒ ì¸ë ¥ ìš´ë°˜', val: 'long_carry', icon: 'footprints' },
                { label: 'ì˜ ëª¨ë¥´ê² ìŒ', desc: 'í˜„ì¥ í™•ì¸ í•„ìš”', val: 'unknown', icon: 'help-circle' }
            ];
            return `
                <div class="space-y-6">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="truck" class="w-6 h-6 text-tc-olive"></i> ìì¬ ë°˜ì… í™˜ê²½ (ì–‘ì¤‘)
                    </h2>
                    <p class="text-sm text-gray-500">ì„¤ì¹˜ ì¥ì†Œë¡œ ìì¬ë¥¼ ì˜®ê¸¸ ìˆ˜ ìˆëŠ” ê°€ì¥ ìœ ì‚¬í•œ ë°©ë²•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                    <div class="grid grid-cols-1 gap-3">
                        ${liftingOptions.map(item => `
                            <button onclick="window.handleAutoNext('liftingType', '${item.val}')" class="p-4 rounded-xl border-2 text-left transition-all flex items-center gap-4 group ${state.formData.liftingType === item.val ? 'border-tc-olive bg-green-50 ring-1 ring-tc-olive' : 'border-gray-200 hover:border-tc-olive hover:bg-gray-50'}">
                                <div class="flex-shrink-0 p-2 rounded-full border border-gray-100 shadow-sm transition-colors ${state.formData.liftingType === item.val ? 'bg-white text-tc-olive' : 'bg-gray-50 text-gray-400 group-hover:text-tc-olive'}">
                                    <i data-lucide="${item.icon}" class="w-8 h-8"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-lg ${state.formData.liftingType === item.val ? 'text-tc-olive' : 'text-gray-800'}">${item.label}</div>
                                    <div class="text-sm text-gray-500">${item.desc}</div>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                    ${renderErrorMsg()}
                </div>
            `;
        }

        function renderStep5() {
            return `
                <div class="space-y-6">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="ruler" class="w-6 h-6 text-tc-olive"></i> ì œí’ˆ ì‚¬ì–‘ ë° ì‚¬ì´ì¦ˆ
                    </h2>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div onclick="window.updateFormData('operationType', 'manual')" class="cursor-pointer p-4 rounded-xl border-2 transition-all relative overflow-hidden ${state.formData.operationType === 'manual' ? 'border-tc-olive bg-green-50 ring-2 ring-tc-olive ring-opacity-50' : 'border-gray-200 hover:border-gray-300'}">
                            <div class="absolute top-0 right-0 p-2 opacity-10"><i data-lucide="sun" class="w-24 h-24"></i></div>
                            <div class="flex justify-between items-center mb-2 relative z-10">
                                <span class="font-bold text-lg">ìˆ˜ë™ (Manual)</span>
                                <i data-lucide="sun" class="w-6 h-6 text-orange-400"></i>
                            </div>
                            <ul class="text-xs text-gray-600 space-y-1 relative z-10">
                                <li class="text-blue-600 font-semibold">âœ” ê²½ì œì ì¸ ê°€ê²©</li>
                                <li>âœ– LED ì˜µì…˜ ì„¤ì¹˜ ì–´ë ¤ì›€</li>
                                <li>âœ– ê¸€ë¼ìŠ¤ ë„ì–´ ì„¤ì¹˜ ì œí•œ</li>
                            </ul>
                        </div>
                        <div onclick="window.updateFormData('operationType', 'electric')" class="cursor-pointer p-4 rounded-xl border-2 transition-all relative overflow-hidden ${state.formData.operationType === 'electric' ? 'border-tc-olive bg-green-50 ring-2 ring-tc-olive ring-opacity-50' : 'border-gray-200 hover:border-gray-300'}">
                            <div class="absolute top-0 right-0 p-2 opacity-10"><i data-lucide="zap" class="w-24 h-24"></i></div>
                            <div class="flex justify-between items-center mb-2 relative z-10">
                                <span class="font-bold text-lg text-tc-olive">ì „ë™ (Electric)</span>
                                <i data-lucide="zap" class="w-6 h-6 text-yellow-500"></i>
                            </div>
                            <ul class="text-xs text-gray-600 space-y-1 relative z-10">
                                <li>âœ” ë¦¬ëª¨ì»¨ ì‘ë™ í¸ë¦¬í•¨</li>
                                <li class="text-blue-600 font-semibold">âœ” LED ì¡°ëª… ì˜µì…˜ ê°€ëŠ¥</li>
                                <li class="text-blue-600 font-semibold">âœ” ê¸€ë¼ìŠ¤ ë„ì–´ í˜¸í™˜ ìš°ìˆ˜</li>
                            </ul>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200">
                        <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                            <i data-lucide="mouse-pointer-click" class="w-5 h-5 text-tc-olive"></i> ì„¤ì¹˜ ê³µê°„ ì‚¬ì´ì¦ˆ (ë‹¨ìœ„: ë¯¸í„° m)
                        </h3>
                        <div class="grid grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 mb-2 ml-1">ê°€ë¡œ (Width)</label>
                                <div class="relative">
                                    <input type="number" id="input-width" value="${state.formData.width}" placeholder="ì˜ˆ: 4" step="0.1" class="w-full p-4 pr-10 border border-gray-300 rounded-xl focus:border-tc-olive outline-none text-2xl font-bold text-center bg-white shadow-sm">
                                    <span class="absolute right-4 top-5 text-gray-400 font-bold">m</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 mb-2 ml-1">ì„¸ë¡œ/ëŒì¶œ (Projection)</label>
                                <div class="relative">
                                    <input type="number" id="input-projection" value="${state.formData.projection}" placeholder="ì˜ˆ: 3" step="0.1" class="w-full p-4 pr-10 border border-gray-300 rounded-xl focus:border-tc-olive outline-none text-2xl font-bold text-center bg-white shadow-sm">
                                    <span class="absolute right-4 top-5 text-gray-400 font-bold">m</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-xl flex items-start gap-3 text-blue-800">
                            <i data-lucide="info" class="w-5 h-5 flex-shrink-0 mt-0.5"></i>
                            <div class="text-sm leading-relaxed">
                                <span class="font-bold block mb-1">ğŸ’¡ ë¶€ë‹´ ê°–ì§€ ë§ê³  ì‘ì„±í•´ì£¼ì„¸ìš”!</span>
                                í˜„ì¥ì—ì„œ ì§ì ‘ ì¤„ìë¡œ ì° ëŒ€ëµì ì¸ ìˆ˜ì¹˜ë§Œ ì ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤. 
                                ì •í™•í•œ mmë‹¨ìœ„ ì‹¤ì¸¡ì€ ê³„ì•½ í›„ <span class="font-bold underline">ì‹œê³µëŒ€í‘œë‹˜ì´ ë°©ë¬¸í•˜ì—¬ ê¼¼ê¼¼í•˜ê²Œ ì§„í–‰</span>í•´ ë“œë¦½ë‹ˆë‹¤.
                            </div>
                        </div>
                    </div>
                    ${renderErrorMsg()}
                </div>
            `;
        }

        function renderStep6() {
            return `
                <div class="space-y-6">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="check-circle" class="w-6 h-6 text-tc-olive"></i> ì¶”ê°€ ì˜µì…˜ ì„ íƒ
                    </h2>
                    
                    <div class="grid grid-cols-1 gap-4">
                        <label class="relative flex items-start gap-4 p-4 rounded-xl border-2 cursor-pointer transition-all ${state.formData.optionLed ? 'border-tc-olive bg-green-50 ring-1 ring-tc-olive' : 'border-gray-200 hover:border-gray-300'}">
                            <div class="flex-shrink-0 mt-1">
                                <input type="checkbox" id="check-led" ${state.formData.optionLed ? 'checked' : ''} class="w-5 h-5 accent-tc-olive">
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-bold text-gray-800 text-lg">LED ì¡°ëª… ì¶”ê°€</span>
                                    <i data-lucide="lightbulb" class="w-6 h-6 ${state.formData.optionLed ? 'text-yellow-500 fill-yellow-500' : 'text-gray-300'}"></i>
                                </div>
                                <p class="text-sm text-gray-500">ì•¼ê°„ì—ë„ ë¶„ìœ„ê¸° ìˆëŠ” í…Œë¼ìŠ¤ë¥¼ ì¦ê²¨ë³´ì„¸ìš”.</p>
                                ${state.formData.operationType === 'manual' && state.formData.optionLed ? `
                                    <p class="mt-2 text-xs text-red-500 bg-red-50 p-2 rounded font-bold">
                                    âš ï¸ ìˆ˜ë™ ëª¨ë¸ì€ LED ì„¤ì¹˜ ì‹œ ë³„ë„ ë°°ì„  ë¹„ìš©ì´ í¬ê²Œ ë°œìƒí•©ë‹ˆë‹¤. (ì „ë™ ì¶”ì²œ)
                                    </p>
                                ` : ''}
                            </div>
                        </label>

                        <div class="p-4 rounded-xl border-2 transition-all ${state.formData.optionGlass !== '' ? 'border-tc-olive bg-green-50 ring-1 ring-tc-olive' : 'border-red-300 bg-red-50'}">
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="door-open" class="w-6 h-6 ${state.formData.optionGlass !== '' ? 'text-blue-500' : 'text-red-400'}"></i>
                                    <span class="font-bold text-gray-800 text-lg">ê¸€ë¼ìŠ¤ ë„ì–´ (í´ë”©/ìŠ¬ë¼ì´ë”©)</span>
                                </div>
                                ${state.formData.optionGlass === '' ? '<span class="text-xs text-red-500 font-bold animate-pulse">â—í•„ìˆ˜ ì„ íƒ</span>' : ''}
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                ${[
                                    { val: 'none', label: 'ì„¤ì¹˜ ì•ˆí•¨' },
                                    { val: 'with', label: 'í•¨ê»˜ ì‹œê³µ (ì¶”ì²œ)' },
                                    { val: 'later', label: 'ì¶”í›„ ì˜ˆì •' }
                                ].map(opt => `
                                    <button onclick="window.updateFormData('optionGlass', '${opt.val}')" class="py-2 rounded-lg text-sm font-medium transition-all ${state.formData.optionGlass === opt.val ? 'bg-tc-olive text-white shadow-md' : 'bg-white border border-gray-300 text-gray-600 hover:bg-gray-50'}">
                                        ${opt.label}
                                    </button>
                                `).join('')}
                            </div>
                            ${state.formData.operationType === 'manual' && state.formData.optionGlass !== '' && state.formData.optionGlass !== 'none' ? `
                                <p class="mt-3 text-xs text-orange-600 bg-orange-50 p-2 rounded font-bold">
                                ğŸ’¡ ìˆ˜ë™ í•¸ë“¤ ê°„ì„­ìœ¼ë¡œ ì¸í•´ ê¸€ë¼ìŠ¤ ë„ì–´ ì„¤ì¹˜ê°€ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                                </p>
                            ` : ''}
                        </div>

                        <label class="relative flex items-start gap-4 p-4 rounded-xl border-2 cursor-pointer transition-all ${state.formData.optionDeck ? 'border-tc-olive bg-green-50 ring-1 ring-tc-olive' : 'border-gray-200 hover:border-gray-300'}">
                            <div class="flex-shrink-0 mt-1">
                                <input type="checkbox" id="check-deck" ${state.formData.optionDeck ? 'checked' : ''} class="w-5 h-5 accent-tc-olive">
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-bold text-gray-800 text-lg">ë°”ë‹¥ ë°í¬ ì‹œê³µ ì˜ë¢°</span>
                                    <i data-lucide="hammer" class="w-6 h-6 ${state.formData.optionDeck ? 'text-brown-500' : 'text-gray-300'}"></i>
                                </div>
                                <p class="text-sm text-gray-500">í•©ì„±ëª©ì¬ ë˜ëŠ” ë°©ë¶€ëª© ë°í¬ ì‹œê³µ ê²¬ì ë„ í•¨ê»˜ ë°›ì•„ë´…ë‹ˆë‹¤.</p>
                            </div>
                        </label>
                    </div>

                    ${renderErrorMsg()}

                    <div class="pt-4">
                        <div class="flex items-start gap-2 text-xs text-gray-500 bg-gray-50 p-3 rounded">
                            <i data-lucide="info" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>
                            <p>
                                'ê²¬ì  í™•ì¸í•˜ê¸°'ë¥¼ ëˆ„ë¥´ì‹œë©´ 
                                <span class="font-bold text-gray-700"> ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ë§ˆì¼€íŒ… í™œìš©</span>ì— ë™ì˜í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°„ì£¼ë˜ë©°, 
                                ì…ë ¥í•˜ì‹  ì •ë³´ê°€ í…Œë¼ê¹Œì‚¬ ë‹´ë‹¹ìì—ê²Œ ì•ˆì „í•˜ê²Œ ì „ì†¡ë©ë‹ˆë‹¤.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderErrorMsg() {
            return state.errorMsg ? `<p class="text-red-500 font-bold text-center animate-pulse p-3 bg-red-100 rounded-lg mt-2">${state.errorMsg}</p>` : '';
        }

        function renderResultModal() {
            const r = state.result;
            if(!r) return '';
            
            const displayPrice = Math.round(r.totalPrice / 10000) * 10000 < r.totalPrice ? (Math.round(r.totalPrice / 10000) * 10000).toLocaleString() : r.totalPrice.toLocaleString();
            
            return `
                <div id="print-area" class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden max-h-[90vh] overflow-y-auto">
                    <div class="bg-tc-olive p-6 text-white text-center">
                        <h2 class="text-3xl font-black mb-1 tracking-tight text-white">TERRACASA</h2>
                        <p class="text-sm opacity-90 font-medium text-white">SMART QUOTATION SYSTEM</p>
                    </div>
                    
                    <div class="p-6 space-y-6">
                        <div class="text-center border-b pb-6 border-gray-100">
                            <p class="text-sm text-gray-500 mb-1">ì´ ì˜ˆìƒ ê²¬ì ê°€ (VAT ë³„ë„)</p>
                            <p class="text-4xl font-black text-gray-800 tracking-tight">
                                ${displayPrice} <span class="text-xl font-normal text-gray-500 ml-1">ì›~</span>
                            </p>
                        </div>

                        ${r.isSwapped ? `
                            <div class="bg-green-50 p-4 rounded-xl border border-green-200 text-sm text-green-800 mb-4 flex items-start gap-2">
                                <i data-lucide="rotate-cw" class="w-5 h-5 flex-shrink-0 mt-0.5 text-green-600"></i>
                                <div>
                                    <span class="font-bold">ê°€ë¡œ/ì„¸ë¡œ ë°©í–¥ ìë™ ìµœì í™” ì ìš©ë¨</span>
                                    <p class="mt-1">
                                        ì…ë ¥í•˜ì‹  ì‚¬ì´ì¦ˆ(${state.formData.width}m x ${state.formData.projection}m)ë³´ë‹¤ 
                                        <span class="font-bold underline"> ë°©í–¥ì„ ë³€ê²½í•˜ì—¬ ì‹œê³µ(${state.formData.projection}m x ${state.formData.width}m)</span>í•˜ëŠ” ê²ƒì´ 
                                        ë” ê²½ì œì ì´ë¼ ì‹œìŠ¤í…œì´ ìë™ìœ¼ë¡œ ìµœì  ê²¬ì ì„ ì‚°ì¶œí–ˆìŠµë‹ˆë‹¤.
                                    </p>
                                </div>
                            </div>
                        ` : ''}

                        ${r.splitInfo ? `
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 text-sm text-blue-800">
                                <p class="font-bold mb-1 flex items-center gap-1">
                                    <i data-lucide="info" class="w-4 h-4"></i> ì‚¬ì´ì¦ˆ ìë™ ë¶„í•  ì•ˆë‚´
                                </p>
                                <div class="mb-2">${r.splitInfo}</div>
                                <div class="text-xs text-blue-600 bg-white/50 p-2 rounded-lg border border-blue-100">
                                   â€» ì‚¬ì´ì¦ˆ ìë™ ë¶„í• ì€ ì‹œìŠ¤í…œ ê¶Œì¥ì‚¬í•­ì´ë©°, <strong>ë‹´ë‹¹ì ìƒë‹´ì„ í†µí•´ ìµœì†Œ ê¸ˆì•¡ìœ¼ë¡œ ì§„í–‰</strong>í•  ìˆ˜ ìˆë„ë¡ ì•ˆë‚´í•´ ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.
                                </div>
                            </div>
                        ` : ''}

                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between border-b pb-2">
                                <span class="text-gray-500">ê³ ê°ëª… / ì—°ë½ì²˜</span>
                                <span class="font-bold">${state.formData.phone}</span>
                            </div>
                            <div class="flex justify-between border-b pb-2">
                                <span class="text-gray-500">ì„¤ì¹˜ ì§€ì—­</span>
                                <span class="font-bold">${state.formData.regionDo} ${state.formData.regionSi}</span>
                            </div>
                            <div class="flex justify-between border-b pb-2">
                                <span class="text-gray-500">ì„ íƒ ëª¨ë¸</span>
                                <span class="font-bold text-tc-olive">${state.formData.operationType === 'manual' ? 'OASIS ìˆ˜ë™' : 'OASIS ì „ë™'}</span>
                            </div>
                            <div class="flex justify-between border-b pb-2">
                                <span class="text-gray-500">ì œí’ˆ ê·œê²© ${r.isSwapped ? '(ìµœì í™”ë¨)' : ''}</span>
                                <span class="font-bold">${r.breakdown.unitW} x ${r.breakdown.unitP} (mm)</span>
                            </div>
                            <div class="flex justify-between border-b pb-2">
                                <span class="text-gray-500">ìˆ˜ëŸ‰</span>
                                <span class="font-bold">${r.breakdown.totalUnits} Set</span>
                            </div>
                            
                            ${r.breakdown.options.map(opt => `
                                <div class="flex justify-between border-b pb-2 text-gray-600">
                                    <span>+ ${opt.name}</span>
                                    <span>${opt.cost > 0 ? `â‚© ${opt.cost.toLocaleString()}` : opt.note}</span>
                                </div>
                            `).join('')}
                            
                            <div class="flex justify-between border-b pb-2 text-gray-600">
                                <span>+ ê¸°ë³¸ ì‹œê³µ/ìš´ì„ë¹„</span>
                                <span>â‚© ${(r.breakdown.labor + r.breakdown.freight).toLocaleString()}</span>
                            </div>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-xl text-xs text-gray-500 space-y-1">
                           <p class="font-bold text-gray-700 mb-1">â€» ìœ ì˜ì‚¬í•­</p>
                           <p>1. ìë™ê²¬ì  í”„ë¡œê·¸ë¨ì— ì§€ì—­ë³„ ì¶œì¥ë¹„ëŠ” ë°˜ì˜ë˜ì–´ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                           <p>2. ìš´ì„ì˜ ê²½ìš° ì œí’ˆì˜ ê°œì†Œì— ë”°ë¼ ì¶”ê°€ ë¶€ê³¼ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                           <p>â€¢ ìœ„ ê¸ˆì•¡ì€ ê°€ê²¬ì ì´ë©° í˜„ì¥ ìƒí™©ì— ë”°ë¼ ë³€ë™ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                           <p>â€¢ ì •í™•í•œ ê²¬ì ì„ ìœ„í•´ ë‹´ë‹¹ìê°€ 3ì¼ ì´ë‚´ë¡œ ì—°ë½ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.</p>
                           <p>â€¢ ê¸€ë¼ìŠ¤ ë„ì–´ ë° ë°í¬ ì‹œê³µë¹„ëŠ” í˜„ì¥ ì‹¤ì¸¡ í›„ ì •í™•íˆ ì‚°ì¶œë©ë‹ˆë‹¤.</p>
                        </div>

                        <div class="grid grid-cols-3 gap-2 print-hidden pt-4">
                            <button onclick="window.closeModal()" class="flex flex-col items-center justify-center p-3 rounded-xl bg-gray-100 text-gray-700 hover:bg-gray-200 transition">
                                <i data-lucide="rotate-ccw" class="w-5 h-5 mb-1 rotate-90"></i>
                                <span class="text-xs font-bold">ì´ì „ìœ¼ë¡œ</span>
                            </button>
                            
                            <button onclick="location.reload()" class="flex flex-col items-center justify-center p-3 rounded-xl bg-gray-100 text-gray-700 hover:bg-gray-200 transition">
                                <i data-lucide="x" class="w-5 h-5 mb-1"></i>
                                <span class="text-xs font-bold">ì¢…ë£Œí•˜ê¸°</span>
                            </button>
                            
                            <button onclick="window.print()" class="flex flex-col items-center justify-center p-3 rounded-xl bg-tc-olive text-white hover:bg-green-800 transition shadow-lg">
                                <i data-lucide="download" class="w-5 h-5 mb-1"></i>
                                <span class="text-xs font-bold">ê²¬ì ì„œ ì €ì¥</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }


        // ==================================================================================
        // [Logic & Event Handlers]
        // ==================================================================================
        function attachEventListeners() {
            // General Inputs
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(el => {
                el.addEventListener('change', (e) => {
                    const id = e.target.id;
                    if(id === 'input-phone') {
                        let val = e.target.value.replace(/[^0-9]/g, '');
                        if (val.length > 3 && val.length <= 7) val = val.slice(0,3) + '-' + val.slice(3);
                        else if (val.length > 7) val = val.slice(0,3) + '-' + val.slice(3,7) + '-' + val.slice(7, 11);
                        state.formData.phone = val;
                        render(); // Re-render for phone formatting
                    } else if (id === 'select-do') {
                        state.formData.regionDo = e.target.value;
                        state.formData.regionSi = '';
                        render();
                    } else if (id === 'select-si') {
                        state.formData.regionSi = e.target.value;
                    } else if (id === 'input-width') {
                        state.formData.width = e.target.value;
                    } else if (id === 'input-projection') {
                        state.formData.projection = e.target.value;
                    } else if (id === 'check-led') {
                        state.formData.optionLed = e.target.checked;
                        render();
                    } else if (id === 'check-deck') {
                        state.formData.optionDeck = e.target.checked;
                        render();
                    }
                    state.errorMsg = "";
                });
            });

            // Buttons
            const btnPrev = document.getElementById('btn-prev');
            if(btnPrev) btnPrev.addEventListener('click', () => { state.step--; state.errorMsg = ""; render(); });

            const btnNext = document.getElementById('btn-next');
            if(btnNext) btnNext.addEventListener('click', handleNext);

            const btnCalc = document.getElementById('btn-calc');
            if(btnCalc) btnCalc.addEventListener('click', calculateQuote);
        }

        // Exposed functions for inline onclick events
        window.handleAutoNext = (field, value) => {
            state.formData[field] = value;
            state.errorMsg = "";
            render(); // Update UI to show selection
            setTimeout(() => {
                state.step++;
                render();
            }, 250);
        };

        window.updateFormData = (field, value) => {
            state.formData[field] = value;
            state.errorMsg = "";
            render();
        };
        
        window.closeModal = () => {
            state.result = null;
            render();
        };

        function validatePhone(phone) {
            const regex = /^010-\d{4}-\d{4}$/;
            return regex.test(phone);
        }

        function handleNext() {
            if (state.step === 1) {
                if (!validatePhone(state.formData.phone)) {
                    state.errorMsg = "íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ 010-0000-0000 í˜•ì‹ìœ¼ë¡œ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                    render();
                    return;
                }
                if (!state.formData.regionDo || !state.formData.regionSi) {
                    state.errorMsg = "ì§€ì—­ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.";
                    render();
                    return;
                }
            }
            // Step 2, 3, 4 are handled by autoNext usually, but if manual next is needed
            if (state.step === 2 && !state.formData.userType) { state.errorMsg = "ê³ ê° êµ¬ë¶„ì„ ì„ íƒí•´ì£¼ì„¸ìš”."; render(); return; }
            if (state.step === 3 && !state.formData.timeline) { state.errorMsg = "ì‹œê³µ ì‹œê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."; render(); return; }
            if (state.step === 4 && !state.formData.liftingType) { state.errorMsg = "ì–‘ì¤‘(ìì¬ë°˜ì…) í™˜ê²½ì„ ì„ íƒí•´ì£¼ì„¸ìš”."; render(); return; }
            
            if (state.step === 5) {
                if (!state.formData.operationType) { state.errorMsg = "êµ¬ë™ ë°©ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”."; render(); return; }
                if (!state.formData.width || !state.formData.projection) { state.errorMsg = "ê°€ë¡œ, ì„¸ë¡œ ì‚¬ì´ì¦ˆë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."; render(); return; }
            }

            state.errorMsg = "";
            state.step++;
            render();
        }

        // ==================================================================================
        // [Logic] Calculation & API
        // ==================================================================================
        function calcPrice(w, p, operationType) {
            const isManual = operationType === 'manual';
            const MAX_W = 4000;
            const MAX_P = 5925;
            
            const reqW = Math.round(parseFloat(w) * 1000);
            const reqP = Math.round(parseFloat(p) * 1000);

            const countW = Math.ceil(reqW / MAX_W);
            const countP = Math.ceil(reqP / MAX_P);
            const totalUnits = countW * countP;
            
            const unitW = Math.round(reqW / countW);
            const unitP = Math.round(reqP / countP);

            const table = isManual ? oasisManualPriceTable : oasisElectricPriceTable;
            const pivotKeys = Object.keys(table).map(Number).sort((a,b)=>a-b);
            
            let matchedPivot = pivotKeys.find(pivot => pivot >= unitP);
            if (!matchedPivot) matchedPivot = pivotKeys[pivotKeys.length - 1]; 

            const getSpanIndex = (span) => {
                if (span <= 1000) return 0;
                if (span <= 1500) return 1;
                if (span <= 2000) return 2;
                if (span <= 2500) return 3;
                if (span <= 3000) return 4;
                if (span <= 3500) return 5;
                return 6; 
            };

            const spanIdx = getSpanIndex(unitW);
            const unitPrice = table[matchedPivot][spanIdx];
            
            return {
                unitPrice,
                totalUnits,
                unitW,
                unitP,
                totalBasePrice: unitPrice * totalUnits
            };
        }

        async function calculateQuote() {
            if (state.step === 6 && state.formData.optionGlass === '') {
                state.errorMsg = "ê¸€ë¼ìŠ¤ ë„ì–´ ì˜µì…˜ì„ ë°˜ë“œì‹œ ì„ íƒí•´ì£¼ì„¸ìš” (ì„¤ì¹˜ ì•ˆí•¨ í¬í•¨)";
                render();
                return;
            }

            state.loading = true;
            state.errorMsg = "";
            render();

            try {
                // 1. Calc Original
                const resultOriginal = calcPrice(state.formData.width, state.formData.projection, state.formData.operationType);
                // 2. Calc Swapped
                const resultSwapped = calcPrice(state.formData.projection, state.formData.width, state.formData.operationType);

                let finalCalc = resultOriginal;
                let isSwapped = false;

                if (resultSwapped.totalUnits < resultOriginal.totalUnits) {
                    finalCalc = resultSwapped;
                    isSwapped = true;
                } else if (resultSwapped.totalUnits === resultOriginal.totalUnits) {
                    if (resultSwapped.totalBasePrice < resultOriginal.totalBasePrice) {
                        finalCalc = resultSwapped;
                        isSwapped = true;
                    }
                }

                let totalPrice = finalCalc.totalBasePrice;
                let optionDetails = [];
                const isManual = state.formData.operationType === 'manual';

                if (state.formData.optionLed) {
                    const ledCost = isManual ? 1000000 : 500000;
                    totalPrice += (ledCost * finalCalc.totalUnits);
                    optionDetails.push({ name: `LED ì¡°ëª… ì˜µì…˜ (${isManual ? 'ìˆ˜ë™í˜•' : 'ì „ë™í˜•'})`, cost: ledCost * finalCalc.totalUnits });
                }

                if (state.formData.optionGlass === 'with') {
                    optionDetails.push({ name: 'ê¸€ë¼ìŠ¤ ë„ì–´ (ìƒì„¸ ì‹¤ì¸¡ í›„ í™•ì •)', cost: 0, note: 'ë³„ë„ ê²¬ì ' });
                }

                if (state.formData.optionDeck) {
                    optionDetails.push({ name: 'ë°í¬ ì‹œê³µ (í˜„ì¥ í™•ì¸ í›„ ê²¬ì )', cost: 0, note: 'ë³„ë„ ê²¬ì ' });
                }

                let freight = 300000;
                if (['ì œì£¼íŠ¹ë³„ìì¹˜ë„'].includes(state.formData.regionDo)) freight = 1800000;
                else if (['ê²½ìƒë¶ë„','ê²½ìƒë‚¨ë„','ë¶€ì‚°ê´‘ì—­ì‹œ','ìš¸ì‚°ê´‘ì—­ì‹œ','ëŒ€êµ¬ê´‘ì—­ì‹œ'].includes(state.formData.regionDo)) freight = 500000;
                else if (['ì „ë¼ë‚¨ë„','ì „ë¶íŠ¹ë³„ìì¹˜ë„','ê´‘ì£¼ê´‘ì—­ì‹œ'].includes(state.formData.regionDo)) freight = 500000;
                
                const labor = 800000 * finalCalc.totalUnits;
                totalPrice += (freight + labor);

                if (['ladder', 'crane', 'long_carry'].includes(state.formData.liftingType)) {
                    optionDetails.push({ name: 'ì–‘ì¤‘ë¹„ (ì‚¬ë‹¤ë¦¬ì°¨/í¬ë ˆì¸/ì†Œìš´ë°˜)', cost: 0, note: 'ë³„ë„ ê²¬ì ' });
                }

                const inputW = Math.round(parseFloat(state.formData.width) * 1000);
                const inputP = Math.round(parseFloat(state.formData.projection) * 1000);

                const quoteResult = {
                    totalPrice: totalPrice,
                    isSwapped: isSwapped,
                    breakdown: {
                        totalUnits: finalCalc.totalUnits,
                        unitW: finalCalc.unitW,
                        unitP: finalCalc.unitP,
                        unitPrice: finalCalc.unitPrice,
                        productTotal: finalCalc.totalBasePrice,
                        freight,
                        labor,
                        options: optionDetails
                    },
                    splitInfo: finalCalc.totalUnits > 1 ? `ì…ë ¥í•˜ì‹  ì‚¬ì´ì¦ˆ(${inputW}x${inputP})ê°€ ìµœëŒ€ ê·œê²©ì„ ì´ˆê³¼í•˜ì—¬, ì•ˆì •ì ì¸ ë‚´êµ¬ì„±ì„ ìœ„í•´ ${finalCalc.totalUnits}ê°œ ëª¨ë“ˆë¡œ ë¶„í•  ì‹œê³µë©ë‹ˆë‹¤.` : null
                };

                await sendEmailToHeadquarters(quoteResult);
                saveToFirestore(quoteResult);
                
                state.result = quoteResult;

            } catch (err) {
                console.error(err);
                state.errorMsg = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message;
            } finally {
                state.loading = false;
                render();
            }
        }

        async function sendEmailToHeadquarters(quoteData) {
            if (!emailJsReady || !window.emailjs) {
                throw new Error("ì´ë©”ì¼ ì „ì†¡ ì‹œìŠ¤í…œì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }

            const templateParams = {
                to_name: "ê´€ë¦¬ì",
                from_name: state.formData.phone,
                message: `
[í…Œë¼ê¹Œì‚¬ ê²¬ì  ìƒì„¸]
--------------------------------
â–  ê³ ê° ì •ë³´
- ì—°ë½ì²˜: ${state.formData.phone}
- ì§€ì—­: ${state.formData.regionDo} ${state.formData.regionSi}
- êµ¬ë¶„: ${state.formData.userType}

â–  ì‹œê³µ ì •ë³´
- ì‹œê¸°: ${state.formData.timeline}
- ì…ë ¥ ì‚¬ì´ì¦ˆ: ${state.formData.width}m x ${state.formData.projection}m
- ì ìš© ëª¨ë¸: ${state.formData.operationType === 'manual' ? 'ìˆ˜ë™(Manual)' : 'ì „ë™(Electric)'}
${quoteData.isSwapped ? 'â€» ìµœì  ê²¬ì ì„ ìœ„í•´ ê°€ë¡œ/ì„¸ë¡œ ë°©í–¥ì´ ë³€ê²½ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.' : ''}

â–  ì˜µì…˜ ë° ê¸ˆì•¡
- ì„ íƒì˜µì…˜: ${state.formData.optionLed ? 'LED ' : ''}${state.formData.optionGlass !== 'none' ? 'ê¸€ë¼ìŠ¤ë„ì–´ ' : ''}${state.formData.optionDeck ? 'ë°í¬' : ''}
- ì´ ê²¬ì ê°€: ${quoteData.totalPrice.toLocaleString()}ì›
--------------------------------
                `
            };

            try {
                await window.emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
                console.log('SUCCESS Email');
            } catch (error) {
                console.error('FAILED Email', error);
                throw new Error(`ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨: ${error.text || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
            }
        }

        async function saveToFirestore(quoteData) {
            try {
                if (!auth.currentUser) return;
                await addDoc(collection(db, 'artifacts', appIdStr, 'public', 'data', 'terracasa_estimates'), {
                    customer: {
                        phone: state.formData.phone,
                        region: `${state.formData.regionDo} ${state.formData.regionSi}`,
                        type: state.formData.userType,
                        timeline: state.formData.timeline
                    },
                    specs: {
                        operation: state.formData.operationType,
                        width: state.formData.width,
                        projection: state.formData.projection,
                        lifting: state.formData.liftingType,
                        measurementNeed: state.formData.measurementNeed,
                        isSwapped: quoteData.isSwapped
                    },
                    options: {
                        led: state.formData.optionLed,
                        glass: state.formData.optionGlass,
                        deck: state.formData.optionDeck
                    },
                    quote: quoteData,
                    createdAt: serverTimestamp(),
                    marketingConsent: true,
                });
            } catch (e) {
                console.error("Firestore save failed:", e);
            }
        }

        // Initialize App
        init();

    </script>
</body>
</html>
