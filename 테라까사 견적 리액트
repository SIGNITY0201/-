import React, { useState, useEffect } from 'react';
import { 
  ChevronRight, 
  CheckCircle, 
  AlertTriangle, 
  Calculator, 
  Phone, 
  Ruler, 
  Sun, 
  Zap,
  Truck,
  User,
  Calendar,
  Info,
  ArrowRightFromLine,
  ArrowUpToLine,
  Construction,
  Footprints,
  HelpCircle,
  Download,
  X,
  RotateCcw,
  Lightbulb,
  DoorOpen,
  Hammer,
  MousePointerClick,
  Send,
  RotateCw
} from 'lucide-react';
import { initializeApp } from "firebase/app";
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "firebase/auth";
import { getFirestore, collection, addDoc, serverTimestamp } from "firebase/firestore";

// ==================================================================================
// [ì„¤ì •] EmailJS í‚¤ ì„¤ì •
// ==================================================================================
const EMAILJS_SERVICE_ID = "service_r3nil9k";   
const EMAILJS_TEMPLATE_ID = "template_2lqnkam"; 
const EMAILJS_PUBLIC_KEY = "uqikvD1GCoxfF_h69";   

// ==================================================================================
// [ì„¤ì •] Firebase ì´ˆê¸°í™”
// ==================================================================================
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// ==================================================================================
// [ë°ì´í„°] ê°€ê²©í‘œ ì„¤ì • (2026 OASIS íŒë§¤ë‹¨ê°€í‘œ - ë¶€ê°€ì„¸ ë³„ë„ ê¸°ì¤€ ë°˜ì˜)
// ==================================================================================

// 1. ìˆ˜ë™(Manual) ê°€ê²©í‘œ
const oasisManualPriceTable = {
    // Key: ëŒì¶œ(Projection), Value: [1000, 1500, 2000, 2500, 3000, 3500, 4000] width êµ¬ê°„ë³„ ê°€ê²©
    2600: [3200000, 3400000, 3600000, 3800000, 4000000, 4200000, 4400000],
    2775: [3240000, 3450000, 3660000, 3870000, 4080000, 4290000, 4500000],
    2950: [3280000, 3500000, 3720000, 3940000, 4160000, 4380000, 4600000],
    3125: [3320000, 3550000, 3780000, 4010000, 4240000, 4470000, 4700000],
    3300: [3360000, 3600000, 3840000, 4080000, 4320000, 4560000, 4800000],
    3475: [3400000, 3650000, 3900000, 4150000, 4400000, 4650000, 4900000],
    3650: [3440000, 3700000, 3960000, 4220000, 4480000, 4740000, 5000000],
    3825: [3480000, 3750000, 4020000, 4290000, 4560000, 4830000, 5100000],
    4000: [3520000, 3800000, 4080000, 4360000, 4640000, 4920000, 5200000],
    4175: [3560000, 3850000, 4140000, 4430000, 4720000, 5010000, 5300000],
    4350: [3600000, 3900000, 4200000, 4500000, 4800000, 5100000, 5400000],
    4525: [3640000, 3950000, 4260000, 4570000, 4880000, 5190000, 5500000],
    4700: [3680000, 4000000, 4320000, 4640000, 4960000, 5280000, 5600000],
    4875: [3720000, 4050000, 4380000, 4710000, 5040000, 5370000, 5700000],
    5050: [3760000, 4100000, 4440000, 4780000, 5120000, 5460000, 5800000],
    5225: [3800000, 4150000, 4500000, 4850000, 5200000, 5550000, 5900000],
    5400: [3840000, 4200000, 4560000, 4920000, 5280000, 5640000, 6000000],
    5575: [3880000, 4250000, 4620000, 4990000, 5360000, 5730000, 6100000],
    5750: [3920000, 4300000, 4680000, 5060000, 5440000, 5820000, 6200000],
    5925: [3960000, 4350000, 4740000, 5130000, 5520000, 5910000, 6300000]
};

// 2. ì „ë™(Electric) ê°€ê²©í‘œ
const oasisElectricPriceTable = {
    // Key: ëŒì¶œ(Projection), Value: [1000, 1500, 2000, 2500, 3000, 3500, 4000] width êµ¬ê°„ë³„ ê°€ê²©
    2600: [3600000, 3850000, 4100000, 4350000, 4600000, 4850000, 5100000],
    2775: [3640000, 3900000, 4160000, 4420000, 4680000, 4940000, 5200000],
    2950: [3680000, 3950000, 4220000, 4490000, 4760000, 5030000, 5300000],
    3125: [3720000, 4000000, 4280000, 4560000, 4840000, 5120000, 5400000],
    3300: [3760000, 4050000, 4340000, 4630000, 4920000, 5210000, 5500000],
    3475: [3800000, 4100000, 4400000, 4700000, 5000000, 5300000, 5600000],
    3650: [3840000, 4150000, 4460000, 4770000, 5080000, 5390000, 5700000],
    3825: [3880000, 4200000, 4520000, 4840000, 5160000, 5480000, 5800000],
    4000: [3920000, 4250000, 4580000, 4910000, 5240000, 5570000, 5900000],
    4175: [3960000, 4300000, 4640000, 4980000, 5320000, 5660000, 6000000],
    4350: [4000000, 4350000, 4700000, 5050000, 5400000, 5750000, 6100000],
    4525: [4040000, 4400000, 4760000, 5120000, 5480000, 5840000, 6200000],
    4700: [4080000, 4450000, 4820000, 5190000, 5560000, 5930000, 6300000],
    4875: [4120000, 4500000, 4880000, 5260000, 5640000, 6020000, 6400000],
    5050: [4160000, 4550000, 4940000, 5330000, 5720000, 6110000, 6500000],
    5225: [4200000, 4600000, 5000000, 5400000, 5800000, 6200000, 6600000],
    5400: [4240000, 4650000, 5060000, 5470000, 5880000, 6290000, 6700000],
    5575: [4280000, 4700000, 5120000, 5540000, 5960000, 6380000, 6800000],
    5750: [4320000, 4750000, 5180000, 5610000, 6040000, 6470000, 6900000],
    5925: [4360000, 4800000, 5240000, 5680000, 6120000, 6560000, 7000000]
};

// [ì§€ì—­ ë°ì´í„°]
const regions = {
    'ì„œìš¸íŠ¹ë³„ì‹œ': ['ê°•ë‚¨êµ¬', 'ê°•ë™êµ¬', 'ê°•ë¶êµ¬', 'ê°•ì„œêµ¬', 'ê´€ì•…êµ¬', 'ê´‘ì§„êµ¬', 'êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬', 'ë…¸ì›êµ¬', 'ë„ë´‰êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ë™ì‘êµ¬', 'ë§ˆí¬êµ¬', 'ì„œëŒ€ë¬¸êµ¬', 'ì„œì´ˆêµ¬', 'ì„±ë™êµ¬', 'ì„±ë¶êµ¬', 'ì†¡íŒŒêµ¬', 'ì–‘ì²œêµ¬', 'ì˜ë“±í¬êµ¬', 'ìš©ì‚°êµ¬', 'ì€í‰êµ¬', 'ì¢…ë¡œêµ¬', 'ì¤‘êµ¬', 'ì¤‘ë‘êµ¬'],
    'ë¶€ì‚°ê´‘ì—­ì‹œ': ['ê°•ì„œêµ¬', 'ê¸ˆì •êµ¬', 'ê¸°ì¥êµ°', 'ë‚¨êµ¬', 'ë™êµ¬', 'ë™ë˜êµ¬', 'ë¶€ì‚°ì§„êµ¬', 'ë¶êµ¬', 'ì‚¬ìƒêµ¬', 'ì‚¬í•˜êµ¬', 'ì„œêµ¬', 'ìˆ˜ì˜êµ¬', 'ì—°ì œêµ¬', 'ì˜ë„êµ¬', 'ì¤‘êµ¬', 'í•´ìš´ëŒ€êµ¬'],
    'ëŒ€êµ¬ê´‘ì—­ì‹œ': ['êµ°ìœ„êµ°', 'ë‚¨êµ¬', 'ë‹¬ì„œêµ¬', 'ë‹¬ì„±êµ°', 'ë™êµ¬', 'ë¶êµ¬', 'ì„œêµ¬', 'ìˆ˜ì„±êµ¬', 'ì¤‘êµ¬'],
    'ì¸ì²œê´‘ì—­ì‹œ': ['ê°•í™”êµ°', 'ê³„ì–‘êµ¬', 'ë‚¨ë™êµ¬', 'ë™êµ¬', 'ë¯¸ì¶”í™€êµ¬', 'ë¶€í‰êµ¬', 'ì„œêµ¬', 'ì—°ìˆ˜êµ¬', 'ì˜¹ì§„êµ°', 'ì¤‘êµ¬'],
    'ê´‘ì£¼ê´‘ì—­ì‹œ': ['ê´‘ì‚°êµ¬', 'ë‚¨êµ¬', 'ë™êµ¬', 'ë¶êµ¬', 'ì„œêµ¬'],
    'ëŒ€ì „ê´‘ì—­ì‹œ': ['ëŒ€ë•êµ¬', 'ë™êµ¬', 'ì„œêµ¬', 'ìœ ì„±êµ¬', 'ì¤‘êµ¬'],
    'ìš¸ì‚°ê´‘ì—­ì‹œ': ['ë‚¨êµ¬', 'ë™êµ¬', 'ë¶êµ¬', 'ìš¸ì£¼êµ°', 'ì¤‘êµ¬'],
    'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ': ['ì„¸ì¢…ì‹œ'],
    'ê²½ê¸°ë„': ['ê°€í‰êµ°', 'ê³ ì–‘ì‹œ', 'ê³¼ì²œì‹œ', 'ê´‘ëª…ì‹œ', 'ê´‘ì£¼ì‹œ', 'êµ¬ë¦¬ì‹œ', 'êµ°í¬ì‹œ', 'ê¹€í¬ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ', 'ë™ë‘ì²œì‹œ', 'ë¶€ì²œì‹œ', 'ì„±ë‚¨ì‹œ', 'ìˆ˜ì›ì‹œ', 'ì‹œí¥ì‹œ', 'ì•ˆì‚°ì‹œ', 'ì•ˆì„±ì‹œ', 'ì•ˆì–‘ì‹œ', 'ì–‘ì£¼ì‹œ', 'ì–‘í‰êµ°', 'ì—¬ì£¼ì‹œ', 'ì—°ì²œêµ°', 'ì˜¤ì‚°ì‹œ', 'ìš©ì¸ì‹œ', 'ì˜ì™•ì‹œ', 'ì˜ì •ë¶€ì‹œ', 'ì´ì²œì‹œ', 'íŒŒì£¼ì‹œ', 'í‰íƒì‹œ', 'í¬ì²œì‹œ', 'í•˜ë‚¨ì‹œ', 'í™”ì„±ì‹œ'],
    'ê°•ì›íŠ¹ë³„ìì¹˜ë„': ['ê°•ë¦‰ì‹œ', 'ê³ ì„±êµ°', 'ë™í•´ì‹œ', 'ì‚¼ì²™ì‹œ', 'ì†ì´ˆì‹œ', 'ì–‘êµ¬êµ°', 'ì–‘ì–‘êµ°', 'ì˜ì›”êµ°', 'ì›ì£¼ì‹œ', 'ì¸ì œêµ°', 'ì •ì„ êµ°', 'ì² ì›êµ°', 'ì¶˜ì²œì‹œ', 'íƒœë°±ì‹œ', 'í‰ì°½êµ°', 'í™ì²œêµ°', 'í™”ì²œêµ°', 'íš¡ì„±êµ°'],
    'ì¶©ì²­ë¶ë„': ['ê´´ì‚°êµ°', 'ë‹¨ì–‘êµ°', 'ë³´ì€êµ°', 'ì˜ë™êµ°', 'ì˜¥ì²œêµ°', 'ìŒì„±êµ°', 'ì œì²œì‹œ', 'ì¦í‰êµ°', 'ì§„ì²œêµ°', 'ì²­ì£¼ì‹œ', 'ì¶©ì£¼ì‹œ'],
    'ì¶©ì²­ë‚¨ë„': ['ê³„ë£¡ì‹œ', 'ê³µì£¼ì‹œ', 'ê¸ˆì‚°êµ°', 'ë…¼ì‚°ì‹œ', 'ë‹¹ì§„ì‹œ', 'ë³´ë ¹ì‹œ', 'ë¶€ì—¬êµ°', 'ì„œì‚°ì‹œ', 'ì„œì²œêµ°', 'ì•„ì‚°ì‹œ', 'ì˜ˆì‚°êµ°', 'ì²œì•ˆì‹œ', 'ì²­ì–‘êµ°', 'íƒœì•ˆêµ°', 'í™ì„±êµ°'],
    'ì „ë¶íŠ¹ë³„ìì¹˜ë„': ['ê³ ì°½êµ°', 'êµ°ì‚°ì‹œ', 'ê¹€ì œì‹œ', 'ë‚¨ì›ì‹œ', 'ë¬´ì£¼êµ°', 'ë¶€ì•ˆêµ°', 'ìˆœì°½êµ°', 'ì™„ì£¼êµ°', 'ìµì‚°ì‹œ', 'ì„ì‹¤êµ°', 'ì¥ìˆ˜êµ°', 'ì „ì£¼ì‹œ', 'ì •ìì‹œ', 'ì§„ì•ˆêµ°'],
    'ì „ë¼ë‚¨ë„': ['ê°•ì§„êµ°', 'ê³ í¥êµ°', 'ê³¡ì„±êµ°', 'ê´‘ì–‘ì‹œ', 'êµ¬ë¡€êµ°', 'ë‚˜ì£¼ì‹œ', 'ë‹´ì–‘êµ°', 'ëª©í¬ì‹œ', 'ë¬´ì•ˆêµ°', 'ë³´ì„±êµ°', 'ìˆœì²œì‹œ', 'ì‹ ì•ˆêµ°', 'ì—¬ìˆ˜ì‹œ', 'ì˜ê´‘êµ°', 'ì˜ì•”êµ°', 'ì™„ë„êµ°', 'ì¥ì„±êµ°', 'ì¥í¥êµ°', 'ì§„ë„êµ°', 'í•¨í‰êµ°', 'í•´ë‚¨êµ°', 'í™”ìˆœêµ°'],
    'ê²½ìƒë¶ë„': ['ê²½ì‚°ì‹œ', 'ê²½ì£¼ì‹œ', 'ê³ ë ¹êµ°', 'êµ¬ë¯¸ì‹œ', 'ê¹€ì²œì‹œ', 'ë¬¸ê²½ì‹œ', 'ë´‰í™”êµ°', 'ìƒì£¼ì‹œ', 'ì„±ì£¼êµ°', 'ì•ˆë™ì‹œ', 'ì˜ë•êµ°', 'ì˜ì–‘êµ°', 'ì˜ì£¼ì‹œ', 'ì˜ì²œì‹œ', 'ì˜ˆì²œêµ°', 'ìš¸ë¦‰êµ°', 'ìš¸ì§„êµ°', 'ì˜ì„±êµ°', 'ì²­ë„êµ°', 'ì²­ì†¡êµ°', 'ì¹ ê³¡êµ°', 'í¬í•­ì‹œ'],
    'ê²½ìƒë‚¨ë„': ['ê±°ì œì‹œ', 'ê±°ì°½êµ°', 'ê³ ì„±êµ°', 'ê¹€í•´ì‹œ', 'ë‚¨í•´êµ°', 'ë°€ì–‘ì‹œ', 'ì‚¬ì²œì‹œ', 'ì‚°ì²­êµ°', 'ì–‘ì‚°ì‹œ', 'ì˜ë ¹êµ°', 'ì§„ì£¼ì‹œ', 'ì°½ë…•êµ°', 'ì°½ì›ì‹œ', 'í†µì˜ì‹œ', 'í•˜ë™êµ°', 'í•¨ì•ˆêµ°', 'í•¨ì–‘êµ°', 'í•©ì²œêµ°'],
    'ì œì£¼íŠ¹ë³„ìì¹˜ë„': ['ì„œê·€í¬ì‹œ', 'ì œì£¼ì‹œ']
};

// --- Sub-Components ---

const Step1_BasicInfo = ({ formData, setFormData, setErrorMsg, handleRegionDoChange }) => (
  <div className="space-y-6">
    <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
      <Phone className="w-6 h-6 text-tc-olive" />
      ê¸°ë³¸ ì •ë³´ ì…ë ¥
    </h2>
    <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r">
      <div className="flex items-start">
        <AlertTriangle className="h-5 w-5 text-yellow-600 mr-2 mt-0.5" />
        <p className="text-sm text-yellow-700 font-bold">
          ì•ˆë‚´: íƒ€ì¸ì˜ ì „í™”ë²ˆí˜¸ë¥¼ ë„ìš©í•˜ì—¬ ê²¬ì ì„ ì‚°ì¶œí•  ê²½ìš° ë²•ì ì¸ ì±…ì„ì´ ë”°ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°˜ë“œì‹œ ë³¸ì¸ì˜ íœ´ëŒ€ì „í™” ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
        </p>
      </div>
    </div>
    
    <div>
      <label className="block text-sm font-medium text-gray-700 mb-1">íœ´ëŒ€í° ë²ˆí˜¸</label>
      <input 
        type="tel" 
        name="phone"
        value={formData.phone}
        onChange={(e) => {
          let val = e.target.value.replace(/[^0-9]/g, '');
          if (val.length > 3 && val.length <= 7) val = val.slice(0,3) + '-' + val.slice(3);
          else if (val.length > 7) val = val.slice(0,3) + '-' + val.slice(3,7) + '-' + val.slice(7, 11);
          setFormData(prev => ({ ...prev, phone: val }));
          setErrorMsg("");
        }}
        placeholder="010-0000-0000"
        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tc-olive focus:border-transparent outline-none transition"
        maxLength={13}
      />
    </div>

    <div className="grid grid-cols-2 gap-3">
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">ì‹œ/ë„</label>
        <select 
          name="regionDo" 
          value={formData.regionDo}
          onChange={handleRegionDoChange}
          className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tc-olive outline-none bg-white"
        >
          <option value="">ì„ íƒ</option>
          {Object.keys(regions).map(r => <option key={r} value={r}>{r}</option>)}
        </select>
      </div>
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">ì‹œ/êµ°/êµ¬</label>
        <select 
          name="regionSi" 
          value={formData.regionSi}
          onChange={(e) => setFormData(prev => ({...prev, regionSi: e.target.value}))}
          disabled={!formData.regionDo}
          className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tc-olive outline-none bg-white disabled:bg-gray-100"
        >
          <option value="">ì„ íƒ</option>
          {formData.regionDo && regions[formData.regionDo].map(s => <option key={s} value={s}>{s}</option>)}
        </select>
      </div>
    </div>
  </div>
);

const Step2_UserType = ({ formData, handleAutoNext, errorMsg }) => (
  <div className="space-y-6">
    <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
      <User className="w-6 h-6 text-tc-olive" />
      ê³ ê° êµ¬ë¶„
    </h2>
    <p className="text-sm text-gray-500">ì •í™•í•œ ìƒë‹´ ë°°ì •ì„ ìœ„í•´ ê³ ê° ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
      {['ê°œì¸ ê³ ê°', 'ì¸í…Œë¦¬ì–´ ì—…ì²´', 'ì¡°ê²½ ì—…ì²´', 'ê±´ì¶•/ì„¤ê³„ì‚¬', 'ê´€ê³µì„œ/ê¸°ì—…'].map(type => (
        <button
          key={type}
          onClick={() => handleAutoNext('userType', type)}
          className={`p-4 rounded-xl border-2 text-left transition-all ${
            formData.userType === type 
            ? 'border-tc-olive bg-green-50 text-tc-olive font-bold shadow-md' 
            : 'border-gray-200 hover:border-tc-olive hover:bg-gray-50'
          }`}
        >
          {type}
        </button>
      ))}
    </div>
    {errorMsg && <p className="text-red-500 font-bold text-center animate-pulse">{errorMsg}</p>}
  </div>
);

const Step3_Timeline = ({ formData, handleAutoNext, errorMsg }) => (
  <div className="space-y-6">
    <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
      <Calendar className="w-6 h-6 text-tc-olive" />
      ì‹œê³µ ì˜ˆì • ì‹œê¸°
    </h2>
    <div className="grid grid-cols-1 gap-3">
      {[
        { label: '1ê°œì›” ì´ë‚´ (ê¸´ê¸‰)', val: 'urgent' },
        { label: '3ê°œì›” ì´ë‚´ (ë³´í†µ)', val: 'normal' },
        { label: '6ê°œì›” ì´ë‚´ (ì—¬ìœ )', val: 'relaxed' },
        { label: '6ê°œì›” ì´í›„ / ê³„íšë‹¨ê³„', val: 'planning' }
      ].map(item => (
        <button
          key={item.val}
          onClick={() => handleAutoNext('timeline', item.val)}
          className={`p-4 rounded-xl border-2 text-left transition-all ${
            formData.timeline === item.val 
            ? 'border-tc-olive bg-green-50 text-tc-olive font-bold shadow-md' 
            : 'border-gray-200 hover:border-tc-olive hover:bg-gray-50'
          }`}
        >
          {item.label}
        </button>
      ))}
    </div>
    {errorMsg && <p className="text-red-500 font-bold text-center animate-pulse">{errorMsg}</p>}
  </div>
);

const Step4_Lifting = ({ formData, handleAutoNext, errorMsg }) => {
  const liftingOptions = [
    { label: 'ì¦‰ì‹œ ì§„ì… ê°€ëŠ¥', desc: '1ì¸µ / í™”ë¬¼ì°¨ í•˜ì°¨ í›„ ì¦‰ì‹œ ì§„ì…', val: 'direct_entry', icon: <ArrowRightFromLine className="w-8 h-8"/> },
    { label: 'ì‚¬ë‹¤ë¦¬ì°¨ ì‚¬ìš©', desc: '1ì¸µ ì´ìƒ / ì§„ì…ë¡œ í˜‘ì†Œ', val: 'ladder', icon: <ArrowUpToLine className="w-8 h-8"/> },
    { label: 'í¬ë ˆì¸ ì‚¬ìš©', desc: 'ê³ ì¸µ / ëŒ€í˜• ì¥ë¹„ í•„ìš”', val: 'crane', icon: <Construction className="w-8 h-8"/> },
    { label: 'ìì¬ ì†Œìš´ë°˜ (20m+)', desc: 'í•˜ì°¨ í›„ 20m ì´ìƒ ì¸ë ¥ ìš´ë°˜', val: 'long_carry', icon: <Footprints className="w-8 h-8"/> },
    { label: 'ì˜ ëª¨ë¥´ê² ìŒ', desc: 'í˜„ì¥ í™•ì¸ í•„ìš”', val: 'unknown', icon: <HelpCircle className="w-8 h-8 text-gray-400"/> }
  ];

  return (
    <div className="space-y-6">
      <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
        <Truck className="w-6 h-6 text-tc-olive" />
        ìì¬ ë°˜ì… í™˜ê²½ (ì–‘ì¤‘)
      </h2>
      <p className="text-sm text-gray-500">ì„¤ì¹˜ ì¥ì†Œë¡œ ìì¬ë¥¼ ì˜®ê¸¸ ìˆ˜ ìˆëŠ” ê°€ì¥ ìœ ì‚¬í•œ ë°©ë²•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
      <div className="grid grid-cols-1 gap-3">
        {liftingOptions.map(item => (
          <button
            key={item.val}
            onClick={() => handleAutoNext('liftingType', item.val)}
            className={`p-4 rounded-xl border-2 text-left transition-all flex items-center gap-4 group ${
              formData.liftingType === item.val 
              ? 'border-tc-olive bg-green-50 ring-1 ring-tc-olive' 
              : 'border-gray-200 hover:border-tc-olive hover:bg-gray-50'
            }`}
          >
            <div className={`flex-shrink-0 p-2 rounded-full border border-gray-100 shadow-sm transition-colors ${
              formData.liftingType === item.val ? 'bg-white text-tc-olive' : 'bg-gray-50 text-gray-400 group-hover:text-tc-olive'
            }`}>
              {item.icon}
            </div>
            <div>
              <div className={`font-bold text-lg ${formData.liftingType === item.val ? 'text-tc-olive' : 'text-gray-800'}`}>
                {item.label}
              </div>
              <div className="text-sm text-gray-500">{item.desc}</div>
            </div>
          </button>
        ))}
      </div>
      {errorMsg && <p className="text-red-500 font-bold text-center animate-pulse">{errorMsg}</p>}
    </div>
  );
};

const Step5_Specs = ({ formData, setFormData, handleChange }) => (
  <div className="space-y-6">
    <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
      <Ruler className="w-6 h-6 text-tc-olive" />
      ì œí’ˆ ì‚¬ì–‘ ë° ì‚¬ì´ì¦ˆ
    </h2>
    
    {/* Operation Type */}
    <div className="grid grid-cols-2 gap-4">
      <div 
        onClick={() => setFormData(prev => ({...prev, operationType: 'manual'}))}
        className={`cursor-pointer p-4 rounded-xl border-2 transition-all relative overflow-hidden ${formData.operationType === 'manual' ? 'border-tc-olive bg-green-50 ring-2 ring-tc-olive ring-opacity-50' : 'border-gray-200 hover:border-gray-300'}`}
      >
        <div className="absolute top-0 right-0 p-2 opacity-10">
            <Sun className="w-24 h-24" />
        </div>
        <div className="flex justify-between items-center mb-2 relative z-10">
          <span className="font-bold text-lg">ìˆ˜ë™ (Manual)</span>
          <Sun className="w-6 h-6 text-orange-400" />
        </div>
        <ul className="text-xs text-gray-600 space-y-1 relative z-10">
          <li className="text-blue-600 font-semibold">âœ” ê²½ì œì ì¸ ê°€ê²©</li>
          <li>âœ– LED ì˜µì…˜ ì„¤ì¹˜ ì–´ë ¤ì›€</li>
          <li>âœ– ê¸€ë¼ìŠ¤ ë„ì–´ ì„¤ì¹˜ ì œí•œ</li>
        </ul>
      </div>
      <div 
        onClick={() => setFormData(prev => ({...prev, operationType: 'electric'}))}
        className={`cursor-pointer p-4 rounded-xl border-2 transition-all relative overflow-hidden ${formData.operationType === 'electric' ? 'border-tc-olive bg-green-50 ring-2 ring-tc-olive ring-opacity-50' : 'border-gray-200 hover:border-gray-300'}`}
      >
        <div className="absolute top-0 right-0 p-2 opacity-10">
            <Zap className="w-24 h-24" />
        </div>
        <div className="flex justify-between items-center mb-2 relative z-10">
          <span className="font-bold text-lg text-tc-olive">ì „ë™ (Electric)</span>
          <Zap className="w-6 h-6 text-yellow-500" />
        </div>
        <ul className="text-xs text-gray-600 space-y-1 relative z-10">
          <li>âœ” ë¦¬ëª¨ì»¨ ì‘ë™ í¸ë¦¬í•¨</li>
          <li className="text-blue-600 font-semibold">âœ” LED ì¡°ëª… ì˜µì…˜ ê°€ëŠ¥</li>
          <li className="text-blue-600 font-semibold">âœ” ê¸€ë¼ìŠ¤ ë„ì–´ í˜¸í™˜ ìš°ìˆ˜</li>
        </ul>
      </div>
    </div>

    {/* Dimensions */}
    <div className="bg-gray-50 p-6 rounded-2xl border border-gray-200">
      <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2">
        <MousePointerClick className="w-5 h-5 text-tc-olive"/>
        ì„¤ì¹˜ ê³µê°„ ì‚¬ì´ì¦ˆ (ë‹¨ìœ„: ë¯¸í„° m)
      </h3>
      <div className="grid grid-cols-2 gap-6 mb-6">
        <div>
          <label className="block text-xs font-semibold text-gray-500 mb-2 ml-1">ê°€ë¡œ (Width)</label>
          <div className="relative">
            <input 
              type="number" 
              name="width"
              value={formData.width}
              onChange={handleChange}
              placeholder="ì˜ˆ: 4"
              className="w-full p-4 pr-10 border border-gray-300 rounded-xl focus:border-tc-olive outline-none text-2xl font-bold text-center bg-white shadow-sm"
              step="0.1"
            />
            <span className="absolute right-4 top-5 text-gray-400 font-bold">m</span>
          </div>
        </div>
        <div>
          <label className="block text-xs font-semibold text-gray-500 mb-2 ml-1">ì„¸ë¡œ/ëŒì¶œ (Projection)</label>
          <div className="relative">
            <input 
              type="number" 
              name="projection"
              value={formData.projection}
              onChange={handleChange}
              placeholder="ì˜ˆ: 3"
              className="w-full p-4 pr-10 border border-gray-300 rounded-xl focus:border-tc-olive outline-none text-2xl font-bold text-center bg-white shadow-sm"
              step="0.1"
            />
            <span className="absolute right-4 top-5 text-gray-400 font-bold">m</span>
          </div>
        </div>
      </div>
      
      {/* Friendly Note */}
      <div className="bg-blue-50 p-4 rounded-xl flex items-start gap-3 text-blue-800">
        <Info className="w-5 h-5 flex-shrink-0 mt-0.5" />
        <div className="text-sm leading-relaxed">
            <span className="font-bold block mb-1">ğŸ’¡ ë¶€ë‹´ ê°–ì§€ ë§ê³  ì‘ì„±í•´ì£¼ì„¸ìš”!</span>
            í˜„ì¥ì—ì„œ ì§ì ‘ ì¤„ìë¡œ ì° ëŒ€ëµì ì¸ ìˆ˜ì¹˜ë§Œ ì ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤. 
            ì •í™•í•œ mmë‹¨ìœ„ ì‹¤ì¸¡ì€ ê³„ì•½ í›„ <span className="font-bold underline">ì‹œê³µëŒ€í‘œë‹˜ì´ ë°©ë¬¸í•˜ì—¬ ê¼¼ê¼¼í•˜ê²Œ ì§„í–‰</span>í•´ ë“œë¦½ë‹ˆë‹¤.
        </div>
      </div>
    </div>
  </div>
);

const Step6_Options = ({ formData, setFormData, handleChange, errorMsg }) => (
  <div className="space-y-6">
    <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
      <CheckCircle className="w-6 h-6 text-tc-olive" />
      ì¶”ê°€ ì˜µì…˜ ì„ íƒ
    </h2>
    
    <div className="grid grid-cols-1 gap-4">
        {/* LED Option Card */}
        <label className={`relative flex items-start gap-4 p-4 rounded-xl border-2 cursor-pointer transition-all ${
            formData.optionLed ? 'border-tc-olive bg-green-50 ring-1 ring-tc-olive' : 'border-gray-200 hover:border-gray-300'
        }`}>
            <div className="flex-shrink-0 mt-1">
                <input 
                    type="checkbox" 
                    checked={formData.optionLed}
                    onChange={(e) => setFormData(prev => ({...prev, optionLed: e.target.checked}))}
                    className="w-5 h-5 accent-tc-olive"
                />
            </div>
            <div className="flex-1">
                <div className="flex justify-between items-center mb-1">
                    <span className="font-bold text-gray-800 text-lg">LED ì¡°ëª… ì¶”ê°€</span>
                    <Lightbulb className={`w-6 h-6 ${formData.optionLed ? 'text-yellow-500 fill-yellow-500' : 'text-gray-300'}`} />
                </div>
                <p className="text-sm text-gray-500">ì•¼ê°„ì—ë„ ë¶„ìœ„ê¸° ìˆëŠ” í…Œë¼ìŠ¤ë¥¼ ì¦ê²¨ë³´ì„¸ìš”.</p>
                {formData.operationType === 'manual' && formData.optionLed && (
                    <p className="mt-2 text-xs text-red-500 bg-red-50 p-2 rounded font-bold">
                    âš ï¸ ìˆ˜ë™ ëª¨ë¸ì€ LED ì„¤ì¹˜ ì‹œ ë³„ë„ ë°°ì„  ë¹„ìš©ì´ í¬ê²Œ ë°œìƒí•©ë‹ˆë‹¤. (ì „ë™ ì¶”ì²œ)
                    </p>
                )}
            </div>
        </label>

        {/* Glass Option Card */}
        <div className={`p-4 rounded-xl border-2 transition-all ${
            formData.optionGlass !== '' ? 'border-tc-olive bg-green-50 ring-1 ring-tc-olive' : 'border-red-300 bg-red-50'
        }`}>
            <div className="flex justify-between items-center mb-3">
                <div className="flex items-center gap-2">
                    <DoorOpen className={`w-6 h-6 ${formData.optionGlass !== '' ? 'text-blue-500' : 'text-red-400'}`} />
                    <span className="font-bold text-gray-800 text-lg">ê¸€ë¼ìŠ¤ ë„ì–´ (í´ë”©/ìŠ¬ë¼ì´ë”©)</span>
                </div>
                {formData.optionGlass === '' && <span className="text-xs text-red-500 font-bold animate-pulse">â—í•„ìˆ˜ ì„ íƒ</span>}
            </div>
            <div className="grid grid-cols-3 gap-2">
                {[
                    { val: 'none', label: 'ì„¤ì¹˜ ì•ˆí•¨' },
                    { val: 'with', label: 'í•¨ê»˜ ì‹œê³µ (ì¶”ì²œ)' },
                    { val: 'later', label: 'ì¶”í›„ ì˜ˆì •' }
                ].map(opt => (
                    <button
                        key={opt.val}
                        onClick={() => handleChange({ target: { name: 'optionGlass', value: opt.val } })}
                        className={`py-2 rounded-lg text-sm font-medium transition-all ${
                            formData.optionGlass === opt.val 
                            ? 'bg-tc-olive text-white shadow-md' 
                            : 'bg-white border border-gray-300 text-gray-600 hover:bg-gray-50'
                        }`}
                    >
                        {opt.label}
                    </button>
                ))}
            </div>
            {formData.operationType === 'manual' && formData.optionGlass !== '' && formData.optionGlass !== 'none' && (
                <p className="mt-3 text-xs text-orange-600 bg-orange-50 p-2 rounded font-bold">
                ğŸ’¡ ìˆ˜ë™ í•¸ë“¤ ê°„ì„­ìœ¼ë¡œ ì¸í•´ ê¸€ë¼ìŠ¤ ë„ì–´ ì„¤ì¹˜ê°€ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            )}
        </div>

        {/* Deck Option Card */}
        <label className={`relative flex items-start gap-4 p-4 rounded-xl border-2 cursor-pointer transition-all ${
            formData.optionDeck ? 'border-tc-olive bg-green-50 ring-1 ring-tc-olive' : 'border-gray-200 hover:border-gray-300'
        }`}>
            <div className="flex-shrink-0 mt-1">
                <input 
                    type="checkbox" 
                    checked={formData.optionDeck}
                    onChange={(e) => setFormData(prev => ({...prev, optionDeck: e.target.checked}))}
                    className="w-5 h-5 accent-tc-olive"
                />
            </div>
            <div className="flex-1">
                <div className="flex justify-between items-center mb-1">
                    <span className="font-bold text-gray-800 text-lg">ë°”ë‹¥ ë°í¬ ì‹œê³µ ì˜ë¢°</span>
                    <Hammer className={`w-6 h-6 ${formData.optionDeck ? 'text-brown-500' : 'text-gray-300'}`} />
                </div>
                <p className="text-sm text-gray-500">í•©ì„±ëª©ì¬ ë˜ëŠ” ë°©ë¶€ëª© ë°í¬ ì‹œê³µ ê²¬ì ë„ í•¨ê»˜ ë°›ì•„ë´…ë‹ˆë‹¤.</p>
            </div>
        </label>
    </div>

    {errorMsg && <div className="p-3 bg-red-100 text-red-600 rounded-lg text-center font-bold animate-pulse">{errorMsg}</div>}

    <div className="pt-4">
      <div className="flex items-start gap-2 text-xs text-gray-500 bg-gray-50 p-3 rounded">
        <Info className="w-4 h-4 mt-0.5 flex-shrink-0" />
        <p>
          'ê²¬ì  í™•ì¸í•˜ê¸°'ë¥¼ ëˆ„ë¥´ì‹œë©´ 
          <span className="font-bold text-gray-700"> ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ë§ˆì¼€íŒ… í™œìš©</span>ì— ë™ì˜í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°„ì£¼ë˜ë©°, 
          ì…ë ¥í•˜ì‹  ì •ë³´ê°€ í…Œë¼ê¹Œì‚¬ ë‹´ë‹¹ìì—ê²Œ ì•ˆì „í•˜ê²Œ ì „ì†¡ë©ë‹ˆë‹¤.
        </p>
      </div>
    </div>
  </div>
);

const ResultModal = ({ result, formData, onClose, onReset, onPrint }) => (
  <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm print:absolute print:inset-0 print:bg-white print:p-0 print:z-[99999]">
    <div id="print-area" className="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden max-h-[90vh] overflow-y-auto print:max-w-none print:shadow-none print:max-h-none print:rounded-none print:w-full print:h-full">
      <div className="bg-tc-olive p-6 text-white text-center print:bg-white print:text-black print:border-b-2 print:border-black">
        <h2 className="text-3xl font-black mb-1 print:text-black tracking-tight">TERRACASA</h2>
        <p className="text-sm opacity-90 print:text-gray-600 font-medium">SMART QUOTATION SYSTEM</p>
      </div>
      
      <div className="p-6 space-y-6">
        <div className="text-center border-b pb-6 border-gray-100 print:border-black">
          <p className="text-sm text-gray-500 mb-1">ì´ ì˜ˆìƒ ê²¬ì ê°€ (VAT ë³„ë„)</p>
          <p className="text-4xl font-black text-gray-800 tracking-tight print:text-black">
            {Math.round(result.totalPrice / 10000) * 10000 < result.totalPrice 
             ? (Math.round(result.totalPrice / 10000) * 10000).toLocaleString() 
             : result.totalPrice.toLocaleString()}
            <span className="text-xl font-normal text-gray-500 ml-1">ì›~</span>
          </p>
        </div>

        {result.isSwapped && (
            <div className="bg-green-50 p-4 rounded-xl border border-green-200 text-sm text-green-800 mb-4 flex items-start gap-2">
                <RotateCw className="w-5 h-5 flex-shrink-0 mt-0.5 text-green-600" />
                <div>
                    <span className="font-bold">ê°€ë¡œ/ì„¸ë¡œ ë°©í–¥ ìë™ ìµœì í™” ì ìš©ë¨</span>
                    <p className="mt-1">
                        ì…ë ¥í•˜ì‹  ì‚¬ì´ì¦ˆ({formData.width}m x {formData.projection}m)ë³´ë‹¤ 
                        <span className="font-bold underline"> ë°©í–¥ì„ ë³€ê²½í•˜ì—¬ ì‹œê³µ({formData.projection}m x {formData.width}m)</span>í•˜ëŠ” ê²ƒì´ 
                        ë” ê²½ì œì ì´ë¼ ì‹œìŠ¤í…œì´ ìë™ìœ¼ë¡œ ìµœì  ê²¬ì ì„ ì‚°ì¶œí–ˆìŠµë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        )}

        {result.splitInfo && (
          <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 text-sm text-blue-800 print:border-gray-300 print:bg-white print:text-black">
            <p className="font-bold mb-1 flex items-center gap-1">
              <Info className="w-4 h-4"/> ì‚¬ì´ì¦ˆ ìë™ ë¶„í•  ì•ˆë‚´
            </p>
            <div className="mb-2">{result.splitInfo}</div>
            <div className="text-xs text-blue-600 bg-white/50 p-2 rounded-lg border border-blue-100">
               â€» ì‚¬ì´ì¦ˆ ìë™ ë¶„í• ì€ ì‹œìŠ¤í…œ ê¶Œì¥ì‚¬í•­ì´ë©°, <strong>ë‹´ë‹¹ì ìƒë‹´ì„ í†µí•´ ìµœì†Œ ê¸ˆì•¡ìœ¼ë¡œ ì§„í–‰</strong>í•  ìˆ˜ ìˆë„ë¡ ì•ˆë‚´í•´ ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.
            </div>
          </div>
        )}

        <div className="space-y-3 text-sm">
          <div className="flex justify-between border-b pb-2">
            <span className="text-gray-500">ê³ ê°ëª… / ì—°ë½ì²˜</span>
            <span className="font-bold">{formData.phone}</span>
          </div>
          <div className="flex justify-between border-b pb-2">
            <span className="text-gray-500">ì„¤ì¹˜ ì§€ì—­</span>
            <span className="font-bold">{formData.regionDo} {formData.regionSi}</span>
          </div>
          <div className="flex justify-between border-b pb-2">
            <span className="text-gray-500">ì„ íƒ ëª¨ë¸</span>
            <span className="font-bold text-tc-olive">{formData.operationType === 'manual' ? 'OASIS ìˆ˜ë™' : 'OASIS ì „ë™'}</span>
          </div>
          <div className="flex justify-between border-b pb-2">
            <span className="text-gray-500">ì œí’ˆ ê·œê²© {result.isSwapped && '(ìµœì í™”ë¨)'}</span>
            <span className="font-bold">{result.breakdown.unitW} x {result.breakdown.unitP} (mm)</span>
          </div>
          <div className="flex justify-between border-b pb-2">
            <span className="text-gray-500">ìˆ˜ëŸ‰</span>
            <span className="font-bold">{result.breakdown.totalUnits} Set</span>
          </div>
          
          {result.breakdown.options.map((opt, idx) => (
            <div key={idx} className="flex justify-between border-b pb-2 text-gray-600">
              <span>+ {opt.name}</span>
              <span>{opt.cost > 0 ? `â‚© ${opt.cost.toLocaleString()}` : opt.note}</span>
            </div>
          ))}
          
          <div className="flex justify-between border-b pb-2 text-gray-600">
            <span>+ ê¸°ë³¸ ì‹œê³µ/ìš´ì„ë¹„</span>
            <span>â‚© {(result.breakdown.labor + result.breakdown.freight).toLocaleString()}</span>
          </div>
        </div>

        <div className="bg-gray-50 p-4 rounded-xl text-xs text-gray-500 space-y-1 print:bg-white print:border print:border-gray-200">
           <p className="font-bold text-gray-700 mb-1">â€» ìœ ì˜ì‚¬í•­</p>
           <p>1. ìë™ê²¬ì  í”„ë¡œê·¸ë¨ì— ì§€ì—­ë³„ ì¶œì¥ë¹„ëŠ” ë°˜ì˜ë˜ì–´ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
           <p>2. ìš´ì„ì˜ ê²½ìš° ì œí’ˆì˜ ê°œì†Œì— ë”°ë¼ ì¶”ê°€ ë¶€ê³¼ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
           <p>â€¢ ìœ„ ê¸ˆì•¡ì€ ê°€ê²¬ì ì´ë©° í˜„ì¥ ìƒí™©ì— ë”°ë¼ ë³€ë™ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
           <p>â€¢ ì •í™•í•œ ê²¬ì ì„ ìœ„í•´ ë‹´ë‹¹ìê°€ 3ì¼ ì´ë‚´ë¡œ ì—°ë½ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.</p>
           <p>â€¢ ê¸€ë¼ìŠ¤ ë„ì–´ ë° ë°í¬ ì‹œê³µë¹„ëŠ” í˜„ì¥ ì‹¤ì¸¡ í›„ ì •í™•íˆ ì‚°ì¶œë©ë‹ˆë‹¤.</p>
        </div>

        {/* Buttons (Hidden when printing) */}
        <div className="grid grid-cols-3 gap-2 print:hidden pt-4">
          <button 
            onClick={onClose}
            className="flex flex-col items-center justify-center p-3 rounded-xl bg-gray-100 text-gray-700 hover:bg-gray-200 transition"
          >
            <RotateCcw className="w-5 h-5 mb-1 rotate-90"/>
            <span className="text-xs font-bold">ì´ì „ìœ¼ë¡œ</span>
          </button>
          
          <button 
            onClick={onReset}
            className="flex flex-col items-center justify-center p-3 rounded-xl bg-gray-100 text-gray-700 hover:bg-gray-200 transition"
          >
            <X className="w-5 h-5 mb-1"/>
            <span className="text-xs font-bold">ì¢…ë£Œí•˜ê¸°</span>
          </button>
          
          <button 
            type="button"
            onClick={onPrint}
            className="flex flex-col items-center justify-center p-3 rounded-xl bg-tc-olive text-white hover:bg-green-800 transition shadow-lg"
          >
            <Download className="w-5 h-5 mb-1"/>
            <span className="text-xs font-bold">ê²¬ì ì„œ ì €ì¥</span>
          </button>
        </div>
      </div>
    </div>
  </div>
);

// --- Main Component ---

export default function TerracasaSelfQuote() {
  const [user, setUser] = useState(null);
  const [step, setStep] = useState(1);
  const [loading, setLoading] = useState(false);
  const [errorMsg, setErrorMsg] = useState("");
  const [result, setResult] = useState(null);
  
  // EmailJS ì¤€ë¹„ ìƒíƒœ í™•ì¸ìš©
  const [emailJsReady, setEmailJsReady] = useState(false);

  // --- Form State ---
  const [formData, setFormData] = useState({
    phone: '',
    regionDo: '',
    regionSi: '',
    userType: '',
    timeline: '',
    liftingType: '',
    operationType: '',
    width: '', // Meters
    projection: '', // Meters
    height: '3000',
    measurementNeed: 'approx',
    optionLed: false,
    optionGlass: '', // Default empty (Required)
    optionDeck: false,
  });

  // --- Auth & EmailJS Init ---
  useEffect(() => {
    // 1. Load EmailJS SDK Dynamically
    const script = document.createElement('script');
    script.src = "https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js";
    script.async = true;
    script.onload = () => {
      // Initialize EmailJS once script is loaded
      if (window.emailjs) {
        window.emailjs.init({
          publicKey: EMAILJS_PUBLIC_KEY,
        });
        setEmailJsReady(true);
        console.log("EmailJS SDK Loaded Successfully");
      }
    };
    script.onerror = () => {
        console.error("Failed to load EmailJS SDK");
    };
    document.body.appendChild(script);

    // 2. Firebase Auth (Backup)
    const initAuth = async () => {
      try {
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }
      } catch (e) {
          console.log("Auth init skipped or failed (EmailJS will still work)", e);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    
    // Cleanup script on unmount
    return () => {
      unsubscribe();
      if(document.body.contains(script)) {
        document.body.removeChild(script);
      }
    };
  }, []);

  const handleChange = (e) => {
    const { name, value, type, checked } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: type === 'checkbox' ? checked : value
    }));
    setErrorMsg("");
  };

  const handleRegionDoChange = (e) => {
    const val = e.target.value; 
    setFormData(prev => ({ ...prev, regionDo: val, regionSi: '' }));
  };
  
  // Auto-advance helper with validation hook
  const handleAutoNext = (field, value) => {
    setFormData(prev => ({ ...prev, [field]: value }));
    setErrorMsg("");
    setTimeout(() => {
        setStep(prev => prev + 1);
    }, 250); // Slight delay for visual feedback
  };

  const validatePhone = (phone) => {
    const regex = /^010-\d{4}-\d{4}$/;
    return regex.test(phone);
  };

  const nextStep = () => {
    if (step === 1) {
      if (!validatePhone(formData.phone)) {
        setErrorMsg("íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ 010-0000-0000 í˜•ì‹ìœ¼ë¡œ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      if (!formData.regionDo || !formData.regionSi) {
        setErrorMsg("ì§€ì—­ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }
    }
    if (step === 2 && !formData.userType) { setErrorMsg("ê³ ê° êµ¬ë¶„ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
    if (step === 3 && !formData.timeline) { setErrorMsg("ì‹œê³µ ì‹œê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
    if (step === 4 && !formData.liftingType) { setErrorMsg("ì–‘ì¤‘(ìì¬ë°˜ì…) í™˜ê²½ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
    if (step === 5) {
      if (!formData.operationType) { setErrorMsg("êµ¬ë™ ë°©ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
      if (!formData.width || !formData.projection) { setErrorMsg("ê°€ë¡œ, ì„¸ë¡œ ì‚¬ì´ì¦ˆë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
    }
    setErrorMsg("");
    setStep(step + 1);
  };

  const prevStep = () => {
    setStep(step - 1);
    setErrorMsg("");
  };

  const handlePrint = () => {
    window.print();
  };

  // ----- [í•µì‹¬ ìˆ˜ì •] ê²¬ì  ê³„ì‚° ë¡œì§ ë¶„ë¦¬ (ë°©í–¥ ì „í™˜ ë¹„êµìš©) -----
  const calcPrice = (w, p, operationType) => {
    const isManual = operationType === 'manual';
    const MAX_W = 4000;
    // Manual Max P: 5925, Electric Max P: 5925 (Both tables now go up to 5925)
    const MAX_P = 5925; 
    
    // m -> mm
    const reqW = Math.round(parseFloat(w) * 1000);
    const reqP = Math.round(parseFloat(p) * 1000);

    const countW = Math.ceil(reqW / MAX_W);
    const countP = Math.ceil(reqP / MAX_P);
    const totalUnits = countW * countP;
    
    const unitW = Math.round(reqW / countW);
    const unitP = Math.round(reqP / countP);

    // í…Œì´ë¸” ì„ íƒ (ìˆ˜ë™ vs ì „ë™)
    const table = isManual ? oasisManualPriceTable : oasisElectricPriceTable;
    const pivotKeys = Object.keys(table).map(Number).sort((a,b)=>a-b);
    
    let matchedPivot = pivotKeys.find(pivot => pivot >= unitP);
    if (!matchedPivot) matchedPivot = pivotKeys[pivotKeys.length - 1]; 

    const getSpanIndex = (span) => {
        if (span <= 1000) return 0;
        if (span <= 1500) return 1;
        if (span <= 2000) return 2;
        if (span <= 2500) return 3;
        if (span <= 3000) return 4;
        if (span <= 3500) return 5;
        return 6; 
    };

    const spanIdx = getSpanIndex(unitW);
    const unitPrice = table[matchedPivot][spanIdx];
    
    return {
        unitPrice,
        totalUnits,
        unitW,
        unitP,
        totalBasePrice: unitPrice * totalUnits
    };
  };

  const calculateQuote = async () => {
    // Validation for Step 6 (Glass Door)
    if (step === 6 && formData.optionGlass === '') {
        setErrorMsg("ê¸€ë¼ìŠ¤ ë„ì–´ ì˜µì…˜ì„ ë°˜ë“œì‹œ ì„ íƒí•´ì£¼ì„¸ìš” (ì„¤ì¹˜ ì•ˆí•¨ í¬í•¨)");
        return;
    }

    setLoading(true);
    setErrorMsg("");

    try {
      // 1. ì…ë ¥ëœ ë°©í–¥ëŒ€ë¡œ ê³„ì‚°
      const resultOriginal = calcPrice(formData.width, formData.projection, formData.operationType);

      // 2. ë°©í–¥ì„ ëŒë ¤ì„œ ê³„ì‚° (ê°€ë¡œ <-> ì„¸ë¡œ)
      const resultSwapped = calcPrice(formData.projection, formData.width, formData.operationType);

      // 3. ë” ì €ë ´í•˜ê±°ë‚˜ ìœ ë‹› ìˆ˜ê°€ ì ì€ ìª½ ì„ íƒ
      // (ê°€ê²©ì´ ê°™ë‹¤ë©´ ìœ ë‹› ìˆ˜ê°€ ì ì€ ìª½ì„, ê·¸ê²ƒë„ ê°™ë‹¤ë©´ ì›ë˜ ì…ë ¥ ë°©í–¥ì„ ì„ í˜¸)
      let finalCalc = resultOriginal;
      let isSwapped = false;

      // ë§Œì•½ ëŒë ¸ì„ ë•Œ ìœ ë‹› ìˆ˜ê°€ ë” ì ë‹¤ë©´ ë¬´ì¡°ê±´ ìœ ë¦¬ (ì‹œê³µë¹„ ì ˆê° ë“±)
      if (resultSwapped.totalUnits < resultOriginal.totalUnits) {
          finalCalc = resultSwapped;
          isSwapped = true;
      } 
      // ìœ ë‹› ìˆ˜ëŠ” ê°™ì€ë° ì œí’ˆ ê°€ê²©ì´ ë” ì‹¸ë‹¤ë©´
      else if (resultSwapped.totalUnits === resultOriginal.totalUnits) {
          if (resultSwapped.totalBasePrice < resultOriginal.totalBasePrice) {
              finalCalc = resultSwapped;
              isSwapped = true;
          }
      }
      
      // Re-calculate total price from scratch based on finalCalc
      let totalPrice = finalCalc.totalBasePrice;
      let optionDetails = [];
      
      const isManual = formData.operationType === 'manual'; // Define isManual here

      if (formData.optionLed) {
        const ledCost = isManual ? 1000000 : 500000;
        totalPrice += (ledCost * finalCalc.totalUnits);
        optionDetails.push({ name: `LED ì¡°ëª… ì˜µì…˜ (${isManual ? 'ìˆ˜ë™í˜•' : 'ì „ë™í˜•'})`, cost: ledCost * finalCalc.totalUnits });
      }

      if (formData.optionGlass === 'with') {
        optionDetails.push({ name: 'ê¸€ë¼ìŠ¤ ë„ì–´ (ìƒì„¸ ì‹¤ì¸¡ í›„ í™•ì •)', cost: 0, note: 'ë³„ë„ ê²¬ì ' });
      }

      if (formData.optionDeck) {
        optionDetails.push({ name: 'ë°í¬ ì‹œê³µ (í˜„ì¥ í™•ì¸ í›„ ê²¬ì )', cost: 0, note: 'ë³„ë„ ê²¬ì ' });
      }

      let freight = 300000;
      if (['ì œì£¼íŠ¹ë³„ìì¹˜ë„'].includes(formData.regionDo)) freight = 1800000;
      else if (['ê²½ìƒë¶ë„','ê²½ìƒë‚¨ë„','ë¶€ì‚°ê´‘ì—­ì‹œ','ìš¸ì‚°ê´‘ì—­ì‹œ','ëŒ€êµ¬ê´‘ì—­ì‹œ'].includes(formData.regionDo)) freight = 500000;
      else if (['ì „ë¼ë‚¨ë„','ì „ë¶íŠ¹ë³„ìì¹˜ë„','ê´‘ì£¼ê´‘ì—­ì‹œ'].includes(formData.regionDo)) freight = 500000;
      
      const labor = 800000 * finalCalc.totalUnits;
      totalPrice += (freight + labor);

      // ìˆ˜ì •: ëª¨ë“  ì–‘ì¤‘ë¹„ëŠ” 'ë³„ë„ ê²¬ì 'ìœ¼ë¡œ ì²˜ë¦¬
      if (['ladder', 'crane', 'long_carry'].includes(formData.liftingType)) {
        optionDetails.push({ name: 'ì–‘ì¤‘ë¹„ (ì‚¬ë‹¤ë¦¬ì°¨/í¬ë ˆì¸/ì†Œìš´ë°˜)', cost: 0, note: 'ë³„ë„ ê²¬ì ' });
      }

      // ì›ë³¸ ì…ë ¥ì¹˜(m)
      const inputW = Math.round(parseFloat(formData.width) * 1000);
      const inputP = Math.round(parseFloat(formData.projection) * 1000);

      const quoteResult = {
        totalPrice: totalPrice,
        isSwapped: isSwapped, // ë°©í–¥ ì „í™˜ ì—¬ë¶€
        breakdown: {
          totalUnits: finalCalc.totalUnits,
          unitW: finalCalc.unitW,
          unitP: finalCalc.unitP,
          unitPrice: finalCalc.unitPrice,
          productTotal: finalCalc.totalBasePrice,
          freight,
          labor,
          options: optionDetails
        },
        splitInfo: finalCalc.totalUnits > 1 ? `ì…ë ¥í•˜ì‹  ì‚¬ì´ì¦ˆ(${inputW}x${inputP})ê°€ ìµœëŒ€ ê·œê²©ì„ ì´ˆê³¼í•˜ì—¬, ì•ˆì •ì ì¸ ë‚´êµ¬ì„±ì„ ìœ„í•´ ${finalCalc.totalUnits}ê°œ ëª¨ë“ˆë¡œ ë¶„í•  ì‹œê³µë©ë‹ˆë‹¤.` : null
      };

      // 1. Send Email (using SDK)
      await sendEmailToHeadquarters(quoteResult);

      // 2. Save to Firestore
      saveToFirestore(quoteResult);
      
      setResult(quoteResult);

    } catch (err) {
      console.error(err);
      setErrorMsg("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
    } finally {
      setLoading(false);
    }
  };

  const sendEmailToHeadquarters = async (quoteData) => {
    // Check if SDK is loaded
    if (!emailJsReady || !window.emailjs) {
        console.warn("EmailJS SDK not ready. Retrying via fetch not recommended.");
        throw new Error("ì´ë©”ì¼ ì „ì†¡ ì‹œìŠ¤í…œì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }

    const templateParams = {
        // [ìˆ˜ì •ë¨] ê¸°ë³¸ í…œí”Œë¦¿(message)ì— ë‚´ìš©ì„ ê½‰ ì±„ì›Œì„œ ë³´ëƒ„
        to_name: "ê´€ë¦¬ì",
        from_name: formData.phone,
        message: `
[í…Œë¼ê¹Œì‚¬ ê²¬ì  ìƒì„¸]
--------------------------------
â–  ê³ ê° ì •ë³´
- ì—°ë½ì²˜: ${formData.phone}
- ì§€ì—­: ${formData.regionDo} ${formData.regionSi}
- êµ¬ë¶„: ${formData.userType}

â–  ì‹œê³µ ì •ë³´
- ì‹œê¸°: ${formData.timeline}
- ì…ë ¥ ì‚¬ì´ì¦ˆ: ${formData.width}m x ${formData.projection}m
- ì ìš© ëª¨ë¸: ${formData.operationType === 'manual' ? 'ìˆ˜ë™(Manual)' : 'ì „ë™(Electric)'}
${quoteData.isSwapped ? 'â€» ìµœì  ê²¬ì ì„ ìœ„í•´ ê°€ë¡œ/ì„¸ë¡œ ë°©í–¥ì´ ë³€ê²½ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.' : ''}

â–  ì˜µì…˜ ë° ê¸ˆì•¡
- ì„ íƒì˜µì…˜: ${formData.optionLed ? 'LED ' : ''}${formData.optionGlass !== 'none' ? 'ê¸€ë¼ìŠ¤ë„ì–´ ' : ''}${formData.optionDeck ? 'ë°í¬' : ''}
- ì´ ê²¬ì ê°€: ${quoteData.totalPrice.toLocaleString()}ì›
--------------------------------
        `,
        // ì•„ë˜ëŠ” ê¸°ì¡´ ê°œë³„ í•„ë“œ (ë‚˜ì¤‘ì— í…œí”Œë¦¿ ìˆ˜ì • ì‹œ ì‚¬ìš© ê°€ëŠ¥)
        phone: formData.phone,
        region: `${formData.regionDo} ${formData.regionSi}`,
        user_type: formData.userType,
        timeline: formData.timeline,
        width: formData.width,
        projection: formData.projection,
        model: formData.operationType === 'manual' ? 'ìˆ˜ë™(Manual)' : 'ì „ë™(Electric)',
        totalPrice: quoteData.totalPrice.toLocaleString(),
        options: `${formData.optionLed ? 'LED ' : ''}${formData.optionGlass !== 'none' ? 'ê¸€ë¼ìŠ¤ë„ì–´ ' : ''}${formData.optionDeck ? 'ë°í¬' : ''}`
    };

    try {
        // Use SDK's send method
        const response = await window.emailjs.send(
            EMAILJS_SERVICE_ID,
            EMAILJS_TEMPLATE_ID,
            templateParams
        );
        console.log('SUCCESS!', response.status, response.text);
    } catch (error) {
        console.error('FAILED...', error);
        // SDK error object usually contains text
        throw new Error(`ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨: ${error.text || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
    }
  };

  const saveToFirestore = async (quoteData) => {
    try {
      if (!auth.currentUser) return; // Guard
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'terracasa_estimates'), {
        customer: {
          phone: formData.phone,
          region: `${formData.regionDo} ${formData.regionSi}`,
          type: formData.userType,
          timeline: formData.timeline
        },
        specs: {
          operation: formData.operationType,
          width: formData.width,
          projection: formData.projection,
          lifting: formData.liftingType,
          measurementNeed: formData.measurementNeed,
          isSwapped: quoteData.isSwapped // DBì—ë„ ë°©í–¥ ì „í™˜ ì—¬ë¶€ ì €ì¥
        },
        options: {
          led: formData.optionLed,
          glass: formData.optionGlass,
          deck: formData.optionDeck
        },
        quote: quoteData,
        createdAt: serverTimestamp(),
        marketingConsent: true,
      });
    } catch (e) {
      console.error("Firestore save failed:", e);
      // Ignore DB errors as Email is primary now
    }
  };

  return (
    <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4 font-sans print:bg-white print:p-0 print:block">
      <style>{`
        .text-tc-olive { color: #4A5D23; }
        .bg-tc-olive { background-color: #4A5D23; }
        .ring-tc-olive { --tw-ring-color: #4A5D23; }
        
        @media print {
          body > * { display: none !important; }
          .fixed, .fixed * { display: block !important; visibility: visible !important; }
          .fixed { position: relative !important; inset: 0 !important; background: white !important; width: 100% !important; height: auto !important; }
          #print-area { 
            box-shadow: none !important; 
            max-width: 100% !important; 
            width: 100% !important; 
            border: none !important;
            margin: 0 !important;
            padding: 0 !important;
          }
          .print\\:hidden { display: none !important; }
          * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
      `}</style>

      <div className="bg-white w-full max-w-xl rounded-2xl shadow-xl overflow-hidden min-h-[600px] flex flex-col print:hidden">
        {/* Header */}
        <div className="bg-white border-b p-4 flex justify-between items-center">
          <h1 className="text-lg font-extrabold text-tc-olive tracking-wide">TERRACASA ESTIMATE</h1>
          <div className="text-xs font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded">Step {step} / 6</div>
        </div>

        {/* Progress Bar */}
        <div className="w-full h-1 bg-gray-100">
          <div 
            className="h-full bg-tc-olive transition-all duration-300 ease-out"
            style={{ width: `${(step / 6) * 100}%` }}
          />
        </div>

        {/* Content Area */}
        <div className="flex-1 p-6 md:p-8 overflow-y-auto">
          {step === 1 && <Step1_BasicInfo formData={formData} setFormData={setFormData} setErrorMsg={setErrorMsg} handleRegionDoChange={handleRegionDoChange} />}
          {step === 2 && <Step2_UserType formData={formData} handleAutoNext={handleAutoNext} errorMsg={errorMsg} />}
          {step === 3 && <Step3_Timeline formData={formData} handleAutoNext={handleAutoNext} errorMsg={errorMsg} />}
          {step === 4 && <Step4_Lifting formData={formData} handleAutoNext={handleAutoNext} errorMsg={errorMsg} />}
          {step === 5 && <Step5_Specs formData={formData} setFormData={setFormData} handleChange={handleChange} />}
          {step === 6 && <Step6_Options formData={formData} setFormData={setFormData} handleChange={handleChange} errorMsg={errorMsg} />}
        </div>

        {/* Footer / Controls */}
        <div className="p-4 bg-white border-t space-y-3">
          {/* Error message is now handled inside steps for better placement, or here for generic */}
          
          <div className="flex gap-3">
            {step > 1 && (
              <button 
                onClick={prevStep}
                className="flex-1 py-3 rounded-xl border border-gray-300 font-bold text-gray-500 hover:bg-gray-50 transition"
              >
                ì´ì „
              </button>
            )}
            
            {step < 6 ? (
              <button 
                onClick={nextStep}
                className="flex-1 py-3 rounded-xl bg-tc-olive text-white font-bold text-lg hover:bg-opacity-90 transition flex justify-center items-center gap-2"
              >
                ë‹¤ìŒ <ChevronRight size={20} />
              </button>
            ) : (
              <button 
                onClick={calculateQuote}
                disabled={loading}
                className="flex-1 py-3 rounded-xl bg-tc-olive text-white font-bold text-lg hover:bg-opacity-90 transition flex justify-center items-center gap-2 disabled:bg-gray-400"
              >
                {loading ? 'ì „ì†¡ì¤‘...' : 'ê²¬ì  í™•ì¸í•˜ê¸°'} {loading ? <Send className="animate-spin" size={20}/> : <Calculator size={20} />}
              </button>
            )}
          </div>
        </div>
      </div>

      {result && (
        <ResultModal 
          result={result} 
          formData={formData} 
          onClose={() => setResult(null)} 
          onReset={() => window.location.reload()}
          onPrint={handlePrint}
        />
      )}
    </div>
  );
}
