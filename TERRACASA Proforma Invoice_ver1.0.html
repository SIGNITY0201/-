<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TERRACASA 시스템 파고라 견적</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Styles for TERRACASA feel (Clean, premium, earthy tones) */
        :root {
            --primary-color: #384236; /* Deep Forest/Terra Green */
            --accent-color: #A9A083; /* Muted Gold/Taupe */
            --bg-color: #f7f5f2; /* Off-white/Cream */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
        }
        .text-primary { color: var(--primary-color); }
        .bg-primary { background-color: var(--primary-color); }
        .border-primary { border-color: var(--primary-color); }
        .text-accent { color: var(--accent-color); }
        .border-accent { border-color: var(--accent-color); }

        /* Custom toggle switch styling */
        .toggle-container {
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            border: 2px solid var(--primary-color);
            border-radius: 9999px;
            overflow: hidden;
            background-color: white;
        }

        .toggle-btn {
            padding: 0.75rem 1rem;
            text-align: center;
            font-weight: 600;
            color: var(--primary-color);
            transition: all 0.3s ease;
            cursor: pointer;
            border-radius: 9999px;
        }

        .toggle-btn.active {
            color: white;
            background-color: var(--primary-color);
            box-shadow: 0 4px 6px rgba(56, 66, 54, 0.2);
        }

        /* Responsive Selection Inputs / Text Input Style */
        .select-input, .text-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: white;
        }
        
        .select-input {
            appearance: none; /* Remove default arrow for select */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23384236'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.5em;
        }

        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Style for the quote button */
        #get-quote-btn {
            transition: background-color 0.3s, transform 0.1s, box-shadow 0.3s;
            background-color: var(--accent-color) !important; /* 항상 보이도록 배경색 강제 적용 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* 상시 그림자 적용 */
        }
        #get-quote-btn:hover {
            background-color: #7d7560 !important; /* hover 색상 강제 적용 */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* hover 시 그림자 강조 */
        }
        #get-quote-btn:active {
            transform: scale(0.99);
        }
        /* Initially hide the result area and the success message */
        #quotation-result-area, #success-message-modal {
            display: none;
        }
        
        /* --- A4 Ratio Style (1:1.414) for On-Screen Preview --- */
        #quotation-app {
            width: 100%;
            max-width: 600px; /* A4 폭 기준 (Desktop Preview) */
            max-height: 850px; /* A4 비율 기준 높이 (600px * 1.414 ≒ 848px) */
            overflow-y: auto; /* 내용이 넘칠 경우 스크롤 허용 */
        }


        /* --- CLEANUP: Remove all print specific styles --- */
        
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-center justify-center">

    <div id="quotation-app" class="w-full max-w-xl bg-white rounded-xl p-6 sm:p-10 card-shadow">

        <!-- Header -->
        <header class="mb-8 border-b pb-4 border-gray-100 print-hidden">
            <h1 class="text-xs font-semibold uppercase tracking-widest text-accent">TERRACASA</h1>
            <h2 class="text-3xl font-bold text-primary mt-1">시스템 파고라 견적 계산기</h2>
            <p class="text-gray-500 text-sm mt-2">원하는 사양을 선택하여 실시간 견적을 확인하세요. (단위: mm, VAT 별도)</p>
        </header>

        <!-- Product Selection Form -->
        <div class="space-y-8">
            
            <!-- NEW: 견적 정보 섹션 (입력 영역) -->
            <div class="quotation-info border-b border-gray-100 pb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-base font-bold text-primary">고객명: </span>
                    <span id="customer-name-display" class="text-xl font-extrabold text-accent"></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm font-bold text-primary">견적 날짜: </span>
                    <span id="quote-date-display" class="text-sm text-gray-600"></span>
                </div>
            </div>

            <!-- 1. Model Selection (모델 선택) -->
            <div class="print-hidden">
                <label for="model-select" class="block text-lg font-bold text-primary mb-3">1. 모델 선택</label>
                <select id="model-select" class="select-input">
                    <option value="oasis_premium" selected>OASIS 국내산 프리미엄 (맞춤제작)</option>
                </select>
            </div>

            <!-- 2. Size Selection (사이즈 선택) -->
            <div class="border-t pt-4 print-hidden">
                <label class="block text-lg font-bold text-primary mb-3">2. 사이즈 선택</label>
                
                <!-- Operation Selection (수동/전동) -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-primary mb-2">구동 방식</label>
                    <div id="operation-toggle" class="toggle-container">
                        <button class="toggle-btn active" data-operation="manual">
                            수동 (Manual)
                        </button>
                        <button class="toggle-btn" data-operation="electric">
                            전동 (Electric)
                        </button>
                    </div>
                </div>

                <!-- Size Inputs (SPAN/PIVOT/HEIGHT) -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- SPAN (가로) - Custom Input -->
                    <div class="col-span-2 sm:col-span-1">
                        <label for="span-input" class="block text-sm font-medium text-primary mb-2">SPAN (가로) (mm)</label>
                        <input type="number" id="span-input" class="text-input focus:outline-none focus:ring-2 focus:ring-accent" 
                               placeholder="가로 길이 입력 (최소 1000, 최대 4000)" min="1000" max="4000">
                    </div>

                    <!-- PIVOT (세로) - Select -->
                    <div class="col-span-2 sm:col-span-1">
                        <label for="pivot-select" class="block text-sm font-medium text-primary mb-2">PIVOT (세로)</label>
                        <select id="pivot-select" class="select-input">
                            <!-- Options filled by JS -->
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <!-- HEIGHT (높이) - Select -->
                    <div class="col-span-2 sm:col-span-1">
                        <label for="height-select" class="block text-sm font-medium text-primary mb-2">높이 선택</label>
                        <select id="height-select" class="select-input">
                            <option value="" disabled selected>--- 선택 ---</option>
                            <option value="under_3500">3500 이하</option>
                            <option value="over_3500">3500 초과 (+500,000 KRW)</option>
                        </select>
                    </div>

                    <!-- QUANTITY (수량) - New Input -->
                    <div class="col-span-2 sm:col-span-1">
                        <label for="quantity-input" class="block text-sm font-medium text-primary mb-2">수량 (개소)</label>
                        <input type="number" id="quantity-input" class="text-input focus:outline-none focus:ring-2 focus:ring-accent" 
                               placeholder="1" min="1" value="1">
                    </div>
                </div>
                
                <!-- Quantity Warning Note (간소화) -->
                <div class="mt-4 text-sm text-gray-500">
                    <p class="flex items-start">
                        <span class="mr-2 text-primary font-bold">*</span> 
                        수량 변동 시 공사/설치 비용이 추후 다르게 청구될 수 있으니, 꼭 정식 견적서를 받아보시기 바랍니다.
                    </p>
                </div>


                <!-- Height Warning and Notes -->
                <div id="height-notes" class="space-y-2 mt-2 text-sm text-gray-500 pt-4">
                    <!-- 공통 안내 문구 -->
                    <p class="flex items-start">
                        <span class="mr-2 text-primary font-bold">*</span> 
                        파고라의 높이는 현장마다 달라질 수 있음으로 특별한 경우가 아니라면 현장에서 맞춤 재단 후 설치하고 있습니다.
                    </p>
                    <!-- 3500 초과 시 조건부 안내 문구 -->
                    <div id="height-warning" class="hidden text-orange-600 space-y-2 p-3 bg-orange-50 rounded-lg">
                        <p class="flex items-start">
                            <span class="mr-2 text-orange-600 font-bold">*</span> 
                            3500mm를 초과하면 자재 유무에 따라 생산 일정이 늘어날 수 있습니다.
                        </p>
                        <p class="flex items-start">
                            <span class="mr-2 text-orange-600 font-bold">*</span> 
                            파고라가 너무 높으면 바람 등 외부 요인에 의해 흔들리는 이슈가 발생할 수 있습니다.
                        </p>
                    </div>
                </div>
            </div>

            <!-- 3. Options Selection (옵션 선택) -->
            <div class="border-t pt-4 print-hidden">
                <label class="block text-lg font-bold text-primary mb-3">3. 옵션 선택</label>

                <!-- LED 옵션 -->
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <input type="checkbox" id="led-option" class="h-5 w-5 text-accent border-gray-300 rounded focus:ring-accent">
                        <label for="led-option" class="ml-3 text-base font-medium text-primary">LED 옵션 추가</label>
                    </div>
                    <span id="led-price-display" class="text-sm text-gray-600">-</span>
                </div>

                <!-- 수동 + LED 선택 시 조건부 안내 문구 -->
                <div id="manual-led-warning" class="hidden text-red-600 space-y-2 p-3 bg-red-50 rounded-lg mt-3">
                    <p class="flex items-start">
                        <span class="mr-2 text-red-600 font-bold">*</span> 
                        **주의:** 수동(Manual) 선택 시 LED 수신기, SMPS, 리모컨, 부속함 등을 별도 구매해야 하므로 LED 비용이 높게 측정될 수 있습니다. 전동(Electric)을 선택하시면 통합 부품으로 더 합리적인 비용이 책정됩니다.
                    </p>
                </div>
            </div>

            <!-- 4. Construction Cost (공사 및 설치비) - NEW SECTION -->
            <div class="border-t pt-4 print-hidden">
                <label class="block text-lg font-bold text-primary mb-3">4. 공사 및 설치비 (운송비/출장비 포함)</label>

                <div class="space-y-4">
                    <!-- 지역 선택 -->
                    <div class="grid grid-cols-2 gap-4">
                        <!-- 지역 (도/특별시) 선택 -->
                        <div>
                            <label for="region-select" class="block text-sm font-medium text-primary mb-2">지역 (도/특별시)</label>
                            <select id="region-select" class="select-input">
                                <!-- Options filled by JS -->
                            </select>
                        </div>

                        <!-- 시/군/구 선택 -->
                        <div>
                            <label for="city-select" class="block text-sm font-medium text-primary mb-2">시/군/구</label>
                            <select id="city-select" class="select-input" disabled>
                                <option value="" disabled selected>--- 선택 ---</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 상세 주소 입력 (신규) -->
                    <div>
                        <label for="address-input" class="block text-sm font-medium text-primary mb-2">상세 주소 (선택 사항)</label>
                        <input type="text" id="address-input" class="text-input focus:outline-none focus:ring-2 focus:ring-accent" 
                               placeholder="예: 경기도 의왕시 내손동 123-4">
                    </div>

                    <!-- 기타 공사 옵션 -->
                    <div class="space-y-2 pt-2">
                        <h4 class="text-sm font-medium text-primary border-b border-gray-100 pb-1">추가 현장 비용 항목</h4>
                        
                        <!-- 0. 전문 시공팀 시공 필요 (80만원) -->
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                            <div class="flex items-center">
                                <input type="checkbox" id="construction-required-option" class="h-5 w-5 text-accent border-gray-300 rounded focus:ring-accent">
                                <label for="construction-required-option" class="ml-3 text-base font-medium text-primary">전문 시공팀 시공 필요</label>
                            </div>
                            <span id="construction-required-price-display" class="text-sm text-gray-600">+ 800,000 KRW</span>
                        </div>

                        <!-- 1. 양중 여부 -->
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                            <div class="flex items-center">
                                <input type="checkbox" id="lifting-option" class="h-5 w-5 text-accent border-gray-300 rounded focus:ring-accent">
                                <label for="lifting-option" class="ml-3 text-base font-medium text-primary">양중 필요 (사다리차/인력)</label>
                            </div>
                            <span id="lifting-price-display" class="text-sm text-gray-600">+ 300,000 KRW</span>
                        </div>

                        <!-- 2. 기초석 작업 -->
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                            <div class="flex items-center">
                                <input type="checkbox" id="foundation-option" class="h-5 w-5 text-accent border-gray-300 rounded focus:ring-accent">
                                <label for="foundation-option" class="ml-3 text-base font-medium text-primary">기초석 작업 필요 (잔디밭 등)</label>
                            </div>
                            <span id="foundation-price-display" class="text-sm text-gray-600">+ 200,000 KRW</span>
                        </div>

                        <!-- 3. 실측 요청 -->
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                            <div class="flex items-center">
                                <input type="checkbox" id="measurement-option" class="h-5 w-5 text-accent border-gray-300 rounded focus:ring-accent">
                                <label for="measurement-option" class="ml-3 text-base font-medium text-primary">사전 실측 요청</label>
                            </div>
                            <span id="measurement-price-display" class="text-sm text-gray-600">+ 200,000 KRW</span>
                        </div>
                    </div>
                    
                    <!-- 추가 공사 희망 항목 (견적 반영) - NEW SECTION -->
                    <div class="space-y-3 pt-4 border-t border-gray-100">
                        <h4 class="text-sm font-bold text-primary pb-1">추가 공사 희망 항목 (견적 포함)</h4>
                        
                        <!-- 1. 유리 픽스창 (m2당) -->
                        <div class="grid grid-cols-4 gap-3 items-center p-2 bg-blue-50 rounded-lg">
                            <label for="glass-fixed-area-input" class="col-span-4 sm:col-span-2 text-sm font-medium text-primary">
                                유리 추가 공사 희망 (픽스창, 자재 m²당 10만원 / 시공 m²당 3만원)
                            </label>
                            <input type="number" id="glass-fixed-area-input" class="col-span-2 sm:col-span-1 text-input focus:ring-accent" 
                                   placeholder="면적 (m²)" min="0" value="0">
                            <span id="glass-fixed-price-display" class="col-span-2 sm:col-span-1 text-sm text-right text-primary font-semibold">
                                + 0 KRW
                            </span>
                        </div>

                        <!-- 2. 유리 글라스 슬라이딩 (짝당) -->
                        <div class="grid grid-cols-4 gap-3 items-center p-2 bg-blue-50 rounded-lg">
                            <label for="glass-sliding-pairs-input" class="col-span-4 sm:col-span-2 text-sm font-medium text-primary">
                                유리 추가 공사 희망 (글라스 슬라이딩, 자재 짝당 50만원 / 시공 짝당 7만원)
                            </label>
                            <input type="number" id="glass-sliding-pairs-input" class="col-span-2 sm:col-span-1 text-input focus:ring-accent" 
                                   placeholder="짝수 (짝)" min="0" value="0">
                            <span id="glass-sliding-price-display" class="col-span-2 sm:col-span-1 text-sm text-right text-primary font-semibold">
                                + 0 KRW
                            </span>
                        </div>
                        <p class="text-xs text-gray-500 ml-2 mt-[-5px] text-red-600">
                            * 글라스 슬라이딩은 최소 시공비 60만원이 발생합니다.
                        </p>

                        <!-- 3. 데크 추가 공사 (m2당) -->
                        <div class="grid grid-cols-4 gap-3 items-center p-2 bg-yellow-50 rounded-lg">
                            <label for="deck-area-input" class="col-span-4 sm:col-span-2 text-sm font-medium text-primary">
                                데크 추가 공사 희망 (합성목 기준, m²당 18만원)
                            </label>
                            <input type="number" id="deck-area-input" class="col-span-2 sm:col-span-1 text-input focus:ring-accent" 
                                   placeholder="면적 (m²)" min="0" value="0">
                            <span id="deck-price-display" class="col-span-2 sm:col-span-1 text-sm text-right text-primary font-semibold">
                                + 0 KRW
                            </span>
                        </div>
                        <p class="text-xs text-gray-500 ml-2 mt-[-5px]">
                            * 데크는 합성목 m²당 18만원 기준이며, 자재 및 시공 방식에 따라 최종 금액이 변동될 수 있습니다.
                        </p>


                        <!-- 4. 기타 추가 공사 (직접 입력) -->
                        <div class="space-y-2 p-2 bg-red-50 rounded-lg">
                            <h5 class="text-sm font-bold text-red-700">기타 추가 공사 희망 (항목 및 금액 직접 입력)</h5>
                            <input type="text" id="other-construction-name" class="text-input w-full focus:ring-red-500" placeholder="항목명 (예: 수도/전기 공사)">
                            <input type="number" id="other-construction-price" class="text-input w-full focus:ring-red-500" placeholder="금액 입력 (KRW, 숫자만)" min="0" value="0">
                            <span id="other-construction-price-display" class="block text-sm text-right text-red-700 font-semibold mt-1">
                                + 0 KRW
                            </span>
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-3 bg-yellow-50 rounded-lg text-sm text-yellow-800">
                    <p class="font-semibold">※ 공사 및 설치 비용 안내</p>
                    <p>시공비(선택 시 80만원), 운송비, 출장비 및 선택된 현장 옵션이 합산됩니다. 최종 공사비는 현장 상황에 따라 변동될 수 있으므로, 정확한 비용은 실측 후 결정됩니다.</p>
                </div>
            </div>
            
            <!-- Customer Information (고객명 표시용) -->
            <div class="customer-input-section border-t pt-4 print-hidden">
                <div class="customer-input-field">
                    <label for="phone-input" class="block text-sm font-medium text-primary mb-2">핸드폰 번호 끝 4자리 (고객명 표시용, 선택 사항)</label>
                    <input type="tel" id="phone-input" class="text-input focus:outline-none focus:ring-2 focus:ring-accent" 
                           placeholder="예: 3977 (선택 사항)" maxlength="4" pattern="[0-9]*" inputmode="numeric">
                </div>
            </div>


            <!-- QUOTE BUTTON -->
            <button id="get-quote-btn" class="w-full py-4 text-xl font-bold rounded-lg text-white bg-accent mt-6 shadow-lg hover:shadow-xl">
                최종 견적 산출하기
            </button>
            
            <!-- Error Message -->
            <div id="error-message" class="hidden p-4 mt-4 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm font-medium"></div>


            <!-- Success Message Modal (삭제됨) -->
            
            <!-- Summary and Result Section (Optimized for Screenshot/Print) -->
            <div id="quotation-result-area" class="pt-4 mt-6">
                
                <!-- --------------------------------------- -->
                <!-- NEW: REPORT HEADER (Client/Date/Phone) -->
                <!-- --------------------------------------- -->
                <div class="mb-6 border-b pb-3 border-primary">
                    <h2 class="text-2xl font-extrabold text-primary mb-2">시스템 파고라 견적서 (가견적)</h2>
                    
                    <!-- NEW: Final Grand Total moved to Header -->
                    <div class="pt-2">
                        <div class="flex justify-between items-end">
                            <span class="text-xl font-bold text-primary">최종 합계 금액</span>
                            <span class="text-xs text-primary">(VAT 별도)</span>
                        </div>
                        <div id="report-grand-total-output" class="text-5xl font-extrabold text-accent text-right mt-1">
                            0 KRW
                        </div>
                    </div>

                    <!-- NEW: Disclaimer moved to Header -->
                    <div class="mt-4 p-2 text-xs text-gray-500 bg-gray-50 rounded-lg">
                        * 본 양식은 빠른 고객 피드백을 위한 **가견적** 양식으로, 선택하신 옵션 및 현장 상황에 따라 정식 견적 금액과 소폭 다를 수 있습니다. 정확한 내용은 담당자의 "정식 견적 회신"을 통해 확인해 주시기 바랍니다.
                    </div>

                    <!-- Retained: Customer Name & Date -->
                    <div class="text-sm space-y-1 mt-4 border-t pt-3">
                        <div class="flex justify-between">
                            <span class="font-bold">고객명:</span>
                            <span class="text-primary font-semibold" id="report-customer-name"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-bold">견적 일자:</span>
                            <span class="text-primary" id="report-quote-date"></span>
                        </div>
                        <!-- 연락처 및 설치예정지역 삭제됨 -->
                    </div>
                </div>

                <!-- --------------------------------------- -->
                <!-- 1. PRODUCT COST (제품 금액) -->
                <!-- --------------------------------------- -->
                <div class="mb-6">
                    <h3 class="list-section-header bg-gray-100 text-lg font-bold text-primary px-3 py-1 mb-2">1. 파고라 금액 (제품 견적, VAT 별도)</h3>
                    <div id="product-breakdown-list" class="text-sm space-y-1">
                        <!-- Content generated by JS -->
                    </div>
                    <div class="flex justify-between mt-3 pt-2 border-t border-primary/50 font-bold">
                        <span class="text-base">파고라 제품 총액:</span>
                        <span id="report-product-total" class="text-xl text-primary">0 KRW</span>
                    </div>
                </div>

                <!-- --------------------------------------- -->
                <!-- 2. INSTALLATION COST (공사/현장 비용) -->
                <!-- --------------------------------------- -->
                <div class="mb-6">
                    <h3 class="list-section-header bg-gray-100 text-lg font-bold text-primary px-3 py-1 mb-2">2. 파고라 공사/현장 비용 (VAT 별도)</h3>
                    <div id="construction-breakdown-list" class="text-sm space-y-1">
                        <!-- Content generated by JS -->
                    </div>
                    <div class="flex justify-between mt-3 pt-2 border-t border-primary/50 font-bold">
                        <span class="text-base">공사/현장 총액:</span>
                        <span id="report-construction-total" class="text-xl text-primary">0 KRW</span>
                    </div>
                </div>

                <!-- --------------------------------------- -->
                <!-- 3. ADDITIONAL COST (추가 공사 항목) -->
                <!-- --------------------------------------- -->
                <div class="mb-6">
                    <h3 class="list-section-header bg-gray-100 text-lg font-bold text-primary px-3 py-1 mb-2">3. 추가 공사 비용 (선택 사항, VAT 별도)</h3>
                    <div id="additional-construction-list" class="text-sm space-y-1">
                        <!-- Content generated by JS -->
                    </div>
                    <div class="flex justify-between mt-3 pt-2 border-t border-primary/50 font-bold">
                        <span class="text-base">추가 공사 총액:</span>
                        <span id="report-additional-total" class="text-xl text-primary">0 KRW</span>
                    </div>
                </div>

                <!-- --------------------------------------- -->
                <!-- FINAL GRAND TOTAL (하단 중복 섹션 삭제) -->
                <!-- --------------------------------------- -->
                
                <!-- Disclaimer (하단 중복 섹션 삭제) -->
                
            </div>

        </div>
    </div>

    <script>
        // 상수 정의
        const BASE_CONSTRUCTION_FEE = 800000; // 시공비 기본 80만원 (선택 사항으로 변경됨)
        const TRIP_FEE = 200000; // 출장비: 200,000 KRW
        const LIFTING_FEE = 300000; // 양중비 30만원 (임의 설정)
        const FOUNDATION_FEE = 200000; // 기초석 비용 20만원
        const MEASUREMENT_FEE = 200000; // 실측 요청 비용 20만원
        const VAT_DIVISOR = 1.1; // VAT 제거를 위한 나누기 값
        
        // --- 추가 공사 항목 상세화 ---
        const GLASS_FIXED_MATERIAL_PER_M2 = 100000; // 유리 픽스창 자재 m2당 10만원
        const GLASS_FIXED_INSTALL_PER_M2 = 30000; // 유리 픽스창 시공 m2당 3만원
        
        const GLASS_SLIDING_MATERIAL_PER_PAIR = 500000; // 글라스 슬라이딩 자재 짝당 50만원
        const GLASS_SLIDING_INSTALL_PER_PAIR = 70000; // 글라스 슬라이딩 시공 짝당 7만원
        const GLASS_SLIDING_INSTALL_MIN_FEE = 600000; // 글라스 슬라이딩 최소 시공비 60만원
        
        const DECK_PER_M2 = 180000; // 데크 합성목 기준 m2당 18만원
        
        const SPAN_OPTIONS = [1000, 1500, 2000, 2500, 3000, 3500, 4000];

        // 가격 데이터 (제품)
        const priceData = {
            manual: {
                2800: { 1000: 3470000, 1500: 3680000, 2000: 3890000, 2500: 4070000, 3000: 4280000, 3500: 4510000, 4000: 4730000 },
                2975: { 1000: 3494000, 1500: 3695000, 2000: 3918000, 2500: 4147000, 3000: 4360000, 3500: 4608000, 4000: 4840000 },
                3125: { 1000: 3542000, 1500: 3795000, 2000: 4048000, 2500: 4301000, 3000: 4554000, 3500: 4807000, 4000: 5060000 },
                3300: { 1000: 3586000, 1500: 3850000, 2000: 4114000, 2500: 4378000, 3000: 4642000, 3500: 4906000, 4000: 5170000 },
                3475: { 1000: 3630000, 1500: 3905000, 2000: 4180000, 2500: 4455000, 3000: 4730000, 3500: 5005000, 4000: 5280000 },
                3630: { 1000: 3698000, 1500: 3968000, 2000: 4248000, 2500: 4532000, 3000: 4818000, 3500: 5104000, 4000: 5390000 },
                3850: { 1000: 3785000, 1500: 4078000, 2000: 4312000, 2500: 4609000, 3000: 4906000, 3500: 5203000, 4000: 5500000 },
                4000: { 1000: 3792000, 1500: 4070000, 2000: 4378000, 2500: 4688000, 3000: 4998000, 3500: 5302000, 4000: 5610000 },
                4175: { 1000: 3806000, 1500: 4125000, 2000: 4444000, 2500: 4763000, 3000: 5082000, 3500: 5401000, 4000: 5720000 },
                4350: { 1000: 3850000, 1500: 4185000, 2000: 4510000, 2500: 4840000, 3000: 5170000, 3500: 5500000, 4000: 5830000 },
                4525: { 1000: 3884000, 1500: 4235000, 2000: 4578000, 2500: 4927000, 3000: 5258000, 3500: 5599000, 4000: 5940000 },
                4700: { 1000: 3938000, 1500: 4292000, 2000: 4642000, 2500: 4994000, 3000: 5346000, 3500: 5698000, 4000: 6050000 },
                4875: { 1000: 3982000, 1500: 4345000, 2000: 4708000, 2500: 5071000, 3000: 5434000, 3500: 5797000, 4000: 6160000 },
                5050: { 1000: 4026000, 1500: 4402000, 2000: 4774000, 2500: 5148000, 3000: 5522000, 3500: 5896000, 4000: 6270000 },
                5225: { 1000: 4070000, 1500: 4455000, 2000: 4840000, 2500: 5225000, 3000: 5610000, 3500: 5995000, 4000: 6380000 },
                5400: { 1000: 4444000, 1500: 4895000, 2000: 5348000, 2500: 5797000, 3000: 6248000, 3500: 6699000, 4000: 7150000 },
            },
            electric: {
                2800: { 1000: 3740000, 1500: 4010000, 2000: 4280000, 2500: 4565000, 3000: 4840000, 3500: 5115000, 4000: 5390000 },
                2975: { 1000: 3784000, 1500: 4070000, 2000: 4356000, 2500: 4642000, 3000: 4908000, 3500: 5214000, 4000: 5500000 },
                3125: { 1000: 3872000, 1500: 4186000, 2000: 4488000, 2500: 4796000, 3000: 5094000, 3500: 5412000, 4000: 5720000 },
                3300: { 1000: 3936000, 1500: 4235000, 2000: 4544000, 2500: 4873000, 3000: 5192000, 3500: 5497000, 4000: 5830000 },
                3475: { 1000: 3996000, 1500: 4295000, 2000: 4620000, 2500: 4950000, 3000: 5280000, 3500: 5610000, 4000: 5940000 },
                3630: { 1000: 4004000, 1500: 4344000, 2000: 4688000, 2500: 5027000, 3000: 5368000, 3500: 5708000, 4000: 6050000 },
                3850: { 1000: 4048000, 1500: 4402000, 2000: 4752000, 2500: 5074000, 3000: 5456000, 3500: 5808000, 4000: 6160000 },
                4000: { 1000: 4092000, 1500: 4455000, 2000: 4818000, 2500: 5188000, 3000: 5544000, 3500: 5907000, 4000: 6270000 },
                4175: { 1000: 4136000, 1500: 4510000, 2000: 4884000, 2500: 5258000, 3000: 5632000, 3500: 6080000, 4000: 6380000 },
                4350: { 1000: 4180000, 1500: 4565000, 2000: 4950000, 2500: 5325000, 3000: 5720000, 3500: 6150000, 4000: 6490000 },
                4525: { 1000: 4224000, 1500: 4620000, 2000: 5016000, 2500: 5412000, 3000: 5808000, 3500: 6204000, 4000: 6600000 },
                4700: { 1000: 4308000, 1500: 4687000, 2000: 5082000, 2500: 5488000, 3000: 5896000, 3500: 6303000, 4000: 6760000 },
                4875: { 1000: 4312000, 1500: 4730000, 2000: 5148000, 2500: 5568000, 3000: 5984000, 3500: 6402000, 4000: 6820000 },
                5050: { 1000: 4356000, 1500: 4784000, 2000: 5214000, 2500: 5643000, 3000: 6072000, 3500: 6501000, 4000: 6930000 },
                5225: { 1000: 4400000, 1500: 4840000, 2000: 5280000, 2500: 5720000, 3000: 6160000, 3500: 6600000, 4000: 7040000 },
                5400: { 1000: 4444000, 1500: 4895000, 2000: 5348000, 2500: 5797000, 3000: 6248000, 3500: 6699000, 4000: 7150000 },
                5575: { 1000: 4488000, 1500: 4950000, 2000: 5412000, 2500: 5874000, 3000: 6336000, 3500: 6798000, 4000: 7260000 },
                5750: { 1000: 4532000, 1500: 5005000, 2000: 5478000, 2500: 5951000, 3000: 6424000, 3500: 6897000, 4000: 7370000 },
                5925: { 1000: 4576000, 1500: 5060000, 2000: 5544000, 2500: 6028000, 3000: 6512000, 3500: 6996000, 4000: 7480000 },
            }
        };
        
        // 지역별 시/군/구 데이터 (대한민국 전지역 확장)
        const regionData = {
            "": ["--- 선택 ---"],
            "seoul": ["--- 선택 ---", "강남구", "강동구", "강북구", "강서구", "관악구", "광진구", "구로구", "금천구", "노원구", "도봉구", "동대문구", "동작구", "마포구", "서대문구", "서초구", "성동구", "성북구", "송파구", "양천구", "영등포구", "용산구", "은평구", "종로구", "중구", "중랑구"],
            "busan": ["--- 선택 ---", "강서구", "금정구", "남구", "동구", "동래구", "진구", "북구", "해운대구", "기장군"],
            "daegu": ["--- 선택 ---", "남구", "달서구", "동구", "북구", "서구", "수성구", "중구", "달성군"],
            "incheon": ["--- 선택 ---", "계양구", "남동구", "동구", "미추홀구", "부평구", "서구", "연수구", "중구", "강화군", "옹진군"],
            "gwangju": ["--- 선택 ---", "광산구", "남구", "동구", "북구", "서구"],
            "daejeon": ["--- 선택 ---", "대덕구", "동구", "서구", "유성구", "중구"],
            "ulsan": ["--- 선택 ---", "남구", "동구", "북구", "중구", "울주군"],
            "sejong": ["--- 선택 ---", "세종시"], // 특별자치시
            "gyeonggi": ["--- 선택 ---", "수원시", "고양시", "용인시", "성남시", "부천시", "화성시", "안산시", "안양시", "평택시", "시흥시", "김포시", "의왕시", "과천시"],
            "gangwon": ["--- 선택 ---", "춘천시", "원주시", "강릉시", "속초시", "동해시", "철원군", "양양군"],
            "chungbuk": ["--- 선택 ---", "청주시", "충주시", "제천시", "옥천군", "영동군", "단양군"],
            "chungnam": ["--- 선택 ---", "천안시", "공주시", "아산시", "서산시", "논산시", "당진시", "보령시"],
            "jeonbuk": ["--- 선택 ---", "전주시", "익산시", "군산시", "정읍시", "남원시", "김제시"],
            "jeonnam": ["--- 선택 ---", "목포시", "여수시", "순천시", "나주시", "광양시", "담양군"],
            "gyeongbuk": ["--- 선택 ---", "포항시", "경주시", "김천시", "안동시", "구미시", "영천시", "상주시"],
            "gyeongnam": ["--- 선택 ---", "창원시", "김해시", "진주시", "양산시", "거제시", "통영시"],
            "jeju": ["--- 선택 ---", "제주시", "서귀포시"] // 특별자치도
        };
        
        const regionNames = {
            "seoul": "서울특별시", "busan": "부산광역시", "daegu": "대구광역시", "incheon": "인천광역시", "gwangju": "광주광역시",
            "daejeon": "대전광역시", "ulsan": "울산광역시", "sejong": "세종특별자치시", "gyeonggi": "경기도", "gangwon": "강원특별자치도",
            "chungbuk": "충청북도", "chungnam": "충청남도", "jeonbuk": "전북특별자치도", "jeonnam": "전라남도", "gyeongbuk": "경상북도",
            "gyeongnam": "경상남도", "jeju": "제주특별자치도"
        };
        
        // 지역별 운송비 (단위: KRW) - 첨부된 이미지 기반
        const shippingCostMap = {
            "seoul": 300000,    // 서울
            "incheon": 300000,  // 인천
            "gyeonggi": 300000, // 경기
            
            "chungnam": 400000, // 충청남도
            "sejong": 400000,   // 세종특별자치시
            "daejeon": 400000,  // 대전광역시
            "chungbuk": 400000, // 충청북도
            
            "gangwon": 500000,  // 강원특별자치도
            "jeonbuk": 500000,  // 전북특별자치도 (전라도 전지역)
            "jeonnam": 500000,  // 전라남도
            "gwangju": 500000,  // 광주광역시
            "gyeongbuk": 500000, // 경상북도 (경상도 전지역)
            "gyeongnam": 500000, // 경상남도
            "daegu": 500000,    // 대구광역시
            "busan": 500000,    // 부산광역시
            "ulsan": 500000,    // 울산광역시
            
            "jeju": 0,          // 제주도: 별도 문의 (견적에 0원으로 반영하고, UI에서 별도 안내)
            "": 0               // 미선택
        };


        // DOM 요소 가져오기
        const modelSelect = document.getElementById('model-select');
        const operationToggle = document.getElementById('operation-toggle');
        const spanInput = document.getElementById('span-input');
        const pivotSelect = document.getElementById('pivot-select');
        const heightSelect = document.getElementById('height-select');
        const heightWarning = document.getElementById('height-warning');
        const quantityInput = document.getElementById('quantity-input'); // NEW

        const getQuoteBtn = document.getElementById('get-quote-btn');
        const quotationResultArea = document.getElementById('quotation-result-area');
        const errorMessage = document.getElementById('error-message');
        
        const ledOptionCheckbox = document.getElementById('led-option');
        const ledPriceDisplay = document.getElementById('led-price-display');
        const manualLedWarning = document.getElementById('manual-led-warning');
        
        const regionSelect = document.getElementById('region-select');
        const citySelect = document.getElementById('city-select');
        const addressInput = document.getElementById('address-input'); // 상세 주소
        const phoneInput = document.getElementById('phone-input'); // 핸드폰 번호 (NEW)

        const successMessageModal = document.getElementById('success-message-modal'); // 성공 메시지 모달 (삭제됨)
        const finalPriceDisplay = document.getElementById('final-price-display'); // 최종 가격 표시 (삭제됨)
        
        const constructionRequiredCheckbox = document.getElementById('construction-required-option'); // 전문 시공팀 시공 필요
        const liftingOptionCheckbox = document.getElementById('lifting-option'); // 양중
        const foundationOptionCheckbox = document.getElementById('foundation-option'); // 기초석
        const measurementOptionCheckbox = document.getElementById('measurement-option'); // 실측

        // 추가 공사 희망 항목 (NEW)
        const glassFixedAreaInput = document.getElementById('glass-fixed-area-input'); // 유리 픽스창 면적
        const glassFixedPriceDisplay = document.getElementById('glass-fixed-price-display');
        const glassSlidingPairsInput = document.getElementById('glass-sliding-pairs-input'); // 글라스 슬라이딩 짝수
        const glassSlidingPriceDisplay = document.getElementById('glass-sliding-price-display');
        const deckAreaInput = document.getElementById('deck-area-input'); // 데크 면적
        const deckPriceDisplay = document.getElementById('deck-price-display');
        const otherConstructionName = document.getElementById('other-construction-name'); // 기타 공사 항목명
        const otherConstructionPrice = document.getElementById('other-construction-price'); // 기타 공사 금액
        const otherConstructionPriceDisplay = document.getElementById('other-construction-price-display');
        
        // Report output elements (NEW)
        const reportCustomerName = document.getElementById('report-customer-name');
        const reportQuoteDate = document.getElementById('report-quote-date');
        const reportPhoneNumber = document.getElementById('report-phone-number');
        const reportLocation = document.getElementById('report-location');

        const productBreakdownList = document.getElementById('product-breakdown-list');
        const reportProductTotal = document.getElementById('report-product-total');
        const constructionBreakdownList = document.getElementById('construction-breakdown-list');
        const reportConstructionTotal = document.getElementById('report-construction-total');
        const additionalConstructionList = document.getElementById('additional-construction-list');
        const reportAdditionalTotal = document.getElementById('report-additional-total');
        const reportGrandTotalOutput = document.getElementById('report-grand-total-output');
        
        const customerNameDisplay = document.getElementById('customer-name-display'); // 고객명 표시
        const quoteDateDisplay = document.getElementById('quote-date-display'); // 견적 날짜 표시
        // const phoneDisplayHidden = document.getElementById('phone-display-hidden'); // 이제 사용 안함

        
        // 현재 선택된 값 (기본값 설정)
        let currentOperation = 'manual';
        
        /**
         * 숫자를 KRW 포맷으로 변환합니다.
         * @param {number} number
         * @returns {string} KRW 포맷 문자열
         */
        function formatKRW(number) {
            if (typeof number !== 'number') return '0 KRW';
            return number.toLocaleString('ko-KR') + ' KRW';
        }

        /**
         * 사용자 입력 SPAN 값에 대해 가격 책정을 위한 표준 SPAN 단위를 결정합니다.
         */
        function determineStandardSpan(inputSpan) {
            if (typeof inputSpan !== 'number' || inputSpan <= 0) return null;
            
            // 4000mm 초과 입력 시 4000mm 기준으로 가격 책정
            if (inputSpan > SPAN_OPTIONS[SPAN_OPTIONS.length - 1]) {
                 return SPAN_OPTIONS[SPAN_OPTIONS.length - 1];
            }

            for (const standardSpan of SPAN_OPTIONS) {
                if (inputSpan <= standardSpan) {
                    return standardSpan;
                }
            }
            
            return null; 
        }

        /**
         * 선택된 작업 모드에 따라 PIVOT 드롭다운 옵션을 업데이트합니다.
         */
        function updatePivotOptions() {
            const pivotOptions = Object.keys(priceData[currentOperation])
                                    .map(p => parseInt(p))
                                    .sort((a, b) => a - b);
            
            pivotSelect.innerHTML = '<option value="" disabled selected>--- 선택 ---</option>';
            pivotOptions.forEach(pivot => {
                const option = document.createElement('option');
                option.value = pivot;
                option.textContent = pivot + ' mm';
                pivotSelect.appendChild(option);
            });

            // 상태 및 요약 업데이트
            // pivotSelect.value = ""; // 초기화 시 선택된 값 없이 시작
            heightSelect.value = "";
            ledOptionCheckbox.checked = false; // 옵션 초기화
            
            // 견적 영역 숨김
            quotationResultArea.style.display = 'none';
            // successMessageModal.style.display = 'none'; // 삭제됨
            updateSummary();
        }

        /**
         * 지역 (도/특별시) 드롭다운 옵션을 채우고, 선택에 따라 시/군/구 드롭다운 옵션을 업데이트합니다.
         */
        function initRegionOptions() {
            regionSelect.innerHTML = ''; // 기존 옵션 비우기
            // '--- 선택 ---' 옵션을 명확히 추가
            const initialOption = document.createElement('option');
            initialOption.value = "";
            initialOption.textContent = "--- 선택 ---";
            initialOption.disabled = true;
            initialOption.selected = true;
            regionSelect.appendChild(initialOption);

            for (const key in regionNames) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = regionNames[key];
                regionSelect.appendChild(option);
            }
            updateCityOptions(); // 초기 시/군/구 업데이트
        }
        
        function updateCityOptions() {
            const selectedRegionKey = regionSelect.value;
            // '--- 선택 ---' 값이거나 유효하지 않은 키인 경우, 빈 목록 또는 '--- 선택 ---'만 표시
            const cities = regionData[selectedRegionKey] || ["--- 선택 ---"];
            
            citySelect.innerHTML = '';
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city === "--- 선택 ---" ? "" : city;
                option.textContent = city;
                // --- FIX: 초기 시/군/구 옵션 선택 상태 설정 ---
                if (city === "--- 선택 ---") {
                    option.disabled = true;
                    option.selected = true;
                }
                // --- FIX END ---
                citySelect.appendChild(option);
            });

            // 지역이 선택되었을 때만 시/군/구 활성화
            citySelect.disabled = selectedRegionKey === "";
        }
        
        /**
         * 선택된 지역에 따른 운송비와 출장비를 계산합니다.
         * @returns {{shipping: number|string, trip: number|string}} 운송비와 출장비 객체
         */
        function calculateShippingCost() {
            const regionKey = regionSelect.value;
            let shipping = shippingCostMap[regionKey] || 0;
            let trip = 0;
            
            // 제주도는 별도 문의
            if (regionKey === 'jeju') {
                return { shipping: '문의', trip: '문의' };
            }

            // 서울/경기(seoul, gyeonggi, incheon)를 제외한 모든 지역 20만원 출장비 발생
            if (regionKey !== 'seoul' && regionKey !== 'gyeonggi' && regionKey !== 'incheon' && regionKey !== '') {
                trip = TRIP_FEE;
            }

            return { shipping: shipping, trip: trip };
        }
        
        /**
         * LED 옵션 가격을 계산합니다. (PIVOT 길이를 m 단위로 올림하여 적용)
         * @param {number} pivotValue 선택된 PIVOT 길이 (mm)
         * @param {boolean} isSelected LED 옵션 선택 여부
         * @returns {number} LED 옵션 가격
         */
        function calculateLedPrice(pivotValue, isSelected) {
            if (!isSelected || isNaN(pivotValue) || pivotValue <= 0) {
                return 0;
            }
            
            // PIVOT 길이를 1000mm(1m) 단위로 올림 (예: 5400mm -> 6m)
            const pivotLengthMetersCeil = Math.ceil(pivotValue / 1000);

            // 공식: (올림된 PIVOT 길이 m) * 2 (양쪽) * 50,000 KRW
            const baseLedCost = pivotLengthMetersCeil * 2 * 50000;
            
            let totalLedCost = baseLedCost;

            // 수동 선택 시 500,000 KRW 추가
            if (currentOperation === 'manual') {
                totalLedCost += 500000;
            }
            
            return totalLedCost;
        }


        /**
         * 선택된 값을 요약 정보에 업데이트하고 고객명을 생성합니다.
         */
        function updateSummary() {
            const quantity = parseInt(quantityInput.value) || 1; 
            
            // --- 1. 고객명 및 날짜 생성 ---
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            quoteDateDisplay.textContent = `${year}년 ${month}월 ${day}일`;

            // --- FIX START: regionSelect.options 접근 시 오류 방지 ---
            // regionSelect.options가 비어있을 수 있으므로 안전하게 처리
            const selectedRegion = regionSelect.options[regionSelect.selectedIndex]?.textContent || ''; 
            const selectedCity = citySelect.value || '';
            const rawPhone = phoneInput.value.trim(); // 전화번호는 4자리만 입력받음
            const phoneLast4 = rawPhone.slice(-4);
            
            // 고객명 형식: 지역 시군구 1234 고객님
            let customerNameText = '미입력';
            
            // '--- 선택 ---'이 아닌 유효한 지역이 선택되었는지 확인
            const validRegionSelected = regionSelect.value !== ""; 
            
            if (validRegionSelected && selectedCity) {
                customerNameText = `${selectedRegion} ${selectedCity}`;
            } else if (validRegionSelected) {
                customerNameText = `${selectedRegion}`;
            }

            if (phoneLast4 && phoneLast4.length === 4) {
                customerNameText += ` ${phoneLast4}`;
            }
            customerNameText += ' 고객님';
            
            customerNameDisplay.textContent = customerNameText;
            // --- FIX END ---
            
            // --- 2. UI 요소 업데이트 ---
            
            // Height Warning Display 
            if (heightSelect.value === 'over_3500') {
                heightWarning.classList.remove('hidden');
            } else {
                heightWarning.classList.add('hidden');
            }
            
            // Options Summary & LED Price Display
            const isLedSelected = ledOptionCheckbox.checked;
            const pivotValue = parseInt(pivotSelect.value);
            const ledPricePerUnit = calculateLedPrice(pivotValue, isLedSelected); 
            
            ledPriceDisplay.textContent = isLedSelected ? formatKRW(ledPricePerUnit) : '-';

            // Manual + LED Warning Display
            if (currentOperation === 'manual' && isLedSelected) {
                manualLedWarning.classList.remove('hidden');
            } else {
                manualLedWarning.classList.add('hidden');
            }
            
            // 추가 공사 항목 금액 디스플레이 업데이트 (견적서에 표시)
            const glassFixedArea = parseFloat(glassFixedAreaInput.value) || 0;
            glassFixedPriceDisplay.textContent = `+ ${formatKRW(glassFixedArea * (GLASS_FIXED_MATERIAL_PER_M2 + GLASS_FIXED_INSTALL_PER_M2))}`;
            
            const glassSlidingPairs = parseInt(glassSlidingPairsInput.value) || 0;
            let glassSlidingTotalCost = (GLASS_SLIDING_MATERIAL_PER_PAIR + GLASS_SLIDING_INSTALL_PER_PAIR) * glassSlidingPairs;

            // 시공비 최소 금액 로직을 UI 표시에는 반영하지 않으나, 총액에 반영될 것임을 안내
            if (glassSlidingPairs > 0 && (glassSlidingPairs * GLASS_SLIDING_INSTALL_PER_PAIR) < GLASS_SLIDING_INSTALL_MIN_FEE) {
                // UI에는 최소 시공비가 포함될 수 있음을 * 로 표시
                glassSlidingPriceDisplay.textContent = `+ ${formatKRW(glassSlidingTotalCost)}*`;
            } else {
                glassSlidingPriceDisplay.textContent = `+ ${formatKRW(glassSlidingTotalCost)}`;
            }

            const deckArea = parseFloat(deckAreaInput.value) || 0;
            deckPriceDisplay.textContent = `+ ${formatKRW(deckArea * DECK_PER_M2)}`;

            const otherPrice = parseInt(otherConstructionPrice.value) || 0;
            otherConstructionPriceDisplay.textContent = `+ ${formatKRW(otherPrice)}`;


            // 견적 영역 숨김
            quotationResultArea.style.display = 'none';
            // successMessageModal.style.display = 'none'; // 삭제됨
        }
        
        /**
         * 최종 가격을 계산하고 견적을 분리하여 표시합니다.
         */
        function calculatePrice() {
            const rawSpan = parseInt(spanInput.value.trim());
            const selectedPivot = parseInt(pivotSelect.value);
            const selectedHeight = heightSelect.value;
            const isLedSelected = ledOptionCheckbox.checked;
            const quantity = parseInt(quantityInput.value) || 1; // NEW: Get quantity

            
            // --- 1. 공사 견적 관련 비용 초기화 및 계산 ---
            let constructionCost = 0; // 기본/현장 공사 총액
            let additionalConstructionCost = 0; // 추가 공사 총액 (유리, 데크, 기타)
            
            // 1.1. 기본 공사 옵션 비용 (1회 기준)
            if (constructionRequiredCheckbox.checked) constructionCost += BASE_CONSTRUCTION_FEE;
            if (liftingOptionCheckbox.checked) constructionCost += LIFTING_FEE;
            if (foundationOptionCheckbox.checked) constructionCost += FOUNDATION_FEE;
            if (measurementOptionCheckbox.checked) constructionCost += MEASUREMENT_FEE;
            
            // 1.2. 운송비 및 출장비 계산 (1회 기준)
            const { shipping, trip } = calculateShippingCost();
            
            if (shipping === '문의') {
                // 제주도 선택 시 처리 (에러로 간주)
                displayError('제주 지역은 운송비/출장비가 별도 문의이므로, 정확한 견적을 위해 고객센터로 연락 주시기 바랍니다.');
                return { totalCost: 0 }; 
            }
            
            constructionCost += shipping;
            constructionCost += trip;
            
            // 1.3. 추가 공사 희망 항목 비용 추가 (추가 공사 항목)
            const glassFixedArea = parseFloat(glassFixedAreaInput.value) || 0;
            const glassSlidingPairs = parseInt(glassSlidingPairsInput.value) || 0;
            const deckArea = parseFloat(deckAreaInput.value) || 0;
            const otherPrice = parseInt(otherConstructionPrice.value) || 0;

            // 유리 픽스창: (자재 + 시공) * 면적
            const glassFixedTotal = glassFixedArea * (GLASS_FIXED_MATERIAL_PER_M2 + GLASS_FIXED_INSTALL_PER_M2);
            additionalConstructionCost += glassFixedTotal;

            // 글라스 슬라이딩: 자재 * 짝수 + 시공(최소 60만원)
            let glassSlidingInstallCost = glassSlidingPairs * GLASS_SLIDING_INSTALL_PER_PAIR;
            if (glassSlidingPairs > 0 && glassSlidingInstallCost < GLASS_SLIDING_INSTALL_MIN_FEE) {
                 glassSlidingInstallCost = GLASS_SLIDING_INSTALL_MIN_FEE; // 최소 시공비 적용
            } else if (glassSlidingPairs === 0) {
                 glassSlidingInstallCost = 0;
            }
            const glassSlidingMaterialCost = glassSlidingPairs * GLASS_SLIDING_MATERIAL_PER_PAIR;
            const glassSlidingTotal = glassSlidingMaterialCost + glassSlidingInstallCost;
            additionalConstructionCost += glassSlidingTotal;

            // 데크: 자재 기준 * 면적
            const deckTotal = deckArea * DECK_PER_M2;
            additionalConstructionCost += deckTotal;

            // 기타 공사
            additionalConstructionCost += otherPrice;

            
            // --- 2. 제품 견적 관련 비용 초기화 및 계산 (수량 반영) ---
            let productCostPerUnit = 0; // Cost for a single unit

            // 2.1. 필수 입력값 유효성 검사 (제품 가격 계산 전에 수행)
            if (isNaN(rawSpan) || !pivotSelect.value || !heightSelect.value || rawSpan < 1000 || quantity < 1 || isNaN(quantity)) {
                displayError('사이즈 (가로, 세로, 높이) 및 수량(최소 1개소)을 모두 선택/입력해 주세요.');
                return { totalCost: 0 }; 
            }
            
            // 2.2. 기본 파고라 가격 (Standard Span 기준, Per Unit)
            const standardSpan = determineStandardSpan(rawSpan);
            
            if (standardSpan) {
                const operationPrices = priceData[currentOperation];
                const pivotPrices = operationPrices[selectedPivot];
                
                if (pivotPrices && pivotPrices[standardSpan]) {
                    // **[수정]** VAT 제거: 나누기 1.1 적용
                    productCostPerUnit = Math.round(pivotPrices[standardSpan] / VAT_DIVISOR);
                }
            }

            if (productCostPerUnit === 0) {
                displayError('선택하신 사이즈 조합에 대한 제품 가격 정보가 없습니다.');
                return { totalCost: 0 };
            }

            // 2.3. 높이 선택 추가 비용 (Per Unit)
            const heightAddPrice = selectedHeight === 'over_3500' ? Math.round(500000 / VAT_DIVISOR) : 0; // **[수정]** VAT 제거
            productCostPerUnit += heightAddPrice;
            
            // 2.4. LED 옵션 추가 비용 (Per Unit)
            const ledPricePerUnit = calculateLedPrice(selectedPivot, isLedSelected);
            productCostPerUnit += ledPricePerUnit;
            
            // 2.5. 최종 제품 견적 (Total Product Cost)
            const totalProductCost = productCostPerUnit * quantity;
            
            // --- 3. 최종 결과 표시 ---
            const totalCost = totalProductCost + constructionCost + additionalConstructionCost;
            
            
            // --- 4. REPORT UI 업데이트 ---
            updateReportUI({
                productCost: totalProductCost,
                constructionCost: constructionCost,
                additionalCost: additionalConstructionCost,
                totalCost: totalCost,
                shipping: shipping,
                trip: trip,
                stdSpan: standardSpan,
                prodCostPerUnit: productCostPerUnit,
                heightAddPrice: heightAddPrice,
                ledPricePerUnit: ledPricePerUnit,
                glassFixedTotal: glassFixedTotal,
                glassSlidingTotal: glassSlidingTotal,
                deckTotal: deckTotal,
                otherPrice: otherPrice,
                glassSlidingInstallCost: glassSlidingInstallCost // for detailed breakdown
            });

            errorMessage.classList.add('hidden');
            // successMessageModal.style.display = 'block'; // 삭제됨
            quotationResultArea.style.display = 'block'; // 결과 영역 표시

            return { productCost: totalProductCost, constructionCost: constructionCost, additionalCost: additionalConstructionCost, totalCost: totalCost };
        }
        
        // 오류 표시 함수 (재사용성)
        function displayError(message) {
            
            // 기존 결과 영역 숨김
            quotationResultArea.style.display = 'none';
            // successMessageModal.style.display = 'none'; // 삭제됨

            // 오류 메시지 표시
            if (errorMessage) {
                errorMessage.textContent = message;
                errorMessage.classList.remove('hidden');
            }
        }
        
        /**
         * Report UI에 계산된 값을 구조화하여 표시합니다.
         */
        function updateReportUI(prices) {
            const rawSpan = spanInput.value.trim();
            const selectedPivot = pivotSelect.value;
            const quantity = parseInt(quantityInput.value) || 1;
            const isLedSelected = ledOptionCheckbox.checked;

            // --- 1. HEADER UPDATE ---
            reportCustomerName.textContent = customerNameDisplay.textContent;
            reportQuoteDate.textContent = quoteDateDisplay.textContent;
            // reportPhoneNumber.textContent = phoneInput.value.trim() || '미입력'; // 삭제됨
            // reportLocation.textContent = ... // 삭제됨
            
            // 최종 합계 금액 업데이트 (헤더로 이동됨)
            reportGrandTotalOutput.textContent = formatKRW(prices.totalCost);


            // --- 2. PRODUCT BREAKDOWN ---
            let productHtml = '';
            
            // 2.1. 기본 제품 가격
            productHtml += `<div class="list-item"><span>모델 (${quantity}개소): ${modelSelect.options[modelSelect.selectedIndex].textContent}</span><span>${formatKRW(prices.prodCostPerUnit * quantity)}</span></div>`;
            productHtml += `<div class="list-item text-xs ml-2"><span>- 사양: ${currentOperation === 'manual' ? '수동' : '전동'}, 가로 ${rawSpan}mm (기준 ${prices.stdSpan}mm), 세로 ${selectedPivot}mm</span><span></span></div>`;
            
            // 2.2. 높이 추가금
            if (prices.heightAddPrice > 0) {
                productHtml += `<div class="list-item text-xs ml-2"><span>- 높이 3500mm 초과 추가금 (${quantity}개소)</span><span>+ ${formatKRW(prices.heightAddPrice * quantity)}</span></div>`;
            }

            // 2.3. LED 옵션
            if (isLedSelected) {
                 productHtml += `<div class="list-item text-xs ml-2"><span>- LED 옵션 (${currentOperation === 'manual' ? '수동 추가금 포함' : '전동 기준'}, ${quantity}개소)</span><span>+ ${formatKRW(prices.ledPricePerUnit * quantity)}</span></div>`;
            }

            productBreakdownList.innerHTML = productHtml;
            reportProductTotal.textContent = formatKRW(prices.productCost);


            // --- 3. CONSTRUCTION BREAKDOWN ---
            let constHtml = '';
            let isConstSelected = false;

            // 3.1. 기본 시공비
            if (constructionRequiredCheckbox.checked) {
                constHtml += `<div class="list-item"><span>전문 시공팀 시공 (1회)</span><span>+ ${formatKRW(BASE_CONSTRUCTION_FEE)}</span></div>`;
                isConstSelected = true;
            } else {
                constHtml += `<div class="list-item text-gray-500"><span>전문 시공팀 시공</span><span>미선택 (직접 시공)</span></div>`;
            }

            // 3.2. 운송비 및 출장비
            if (prices.shipping > 0 || prices.trip > 0) {
                constHtml += `<div class="list-item"><span>운송비 및 출장비</span><span>+ ${formatKRW(prices.shipping + prices.trip)}</span></div>`;
                isConstSelected = true;
            } else if (prices.shipping === '문의') {
                constHtml += `<div class="list-item"><span>운송비 및 출장비 (제주)</span><span class="text-red-500">별도 문의</span></div>`;
            } else {
                 constHtml += `<div class="list-item text-gray-500"><span>운송비 및 출장비</span><span>0 KRW</span></div>`;
            }
            
            // 3.3. 현장 옵션
            if (liftingOptionCheckbox.checked) constHtml += `<div class="list-item"><span>양중 (사다리차/인력)</span><span>+ ${formatKRW(LIFTING_FEE)}</span></div>`;
            if (foundationOptionCheckbox.checked) constHtml += `<div class="list-item"><span>기초석 작업 (잔디밭 등)</span><span>+ ${formatKRW(FOUNDATION_FEE)}</span></div>`;
            if (measurementOptionCheckbox.checked) constHtml += `<div class="list-item"><span>사전 실측 요청</span><span>+ ${formatKRW(MEASUREMENT_FEE)}</span></div>`;
            
            constructionBreakdownList.innerHTML = constHtml;
            reportConstructionTotal.textContent = formatKRW(prices.constructionCost);


            // --- 4. ADDITIONAL CONSTRUCTION BREAKDOWN ---
            let addConstHtml = '';
            let additionalTotal = 0;
            
            // 4.1. 유리 픽스창
            if (glassFixedAreaInput.value > 0) {
                addConstHtml += `<div class="list-item"><span>유리 픽스창 ${glassFixedAreaInput.value}m² (자재+시공)</span><span>+ ${formatKRW(prices.glassFixedTotal)}</span></div>`;
                additionalTotal += prices.glassFixedTotal;
            }

            // 4.2. 글라스 슬라이딩
            if (glassSlidingPairsInput.value > 0) {
                const materialCost = glassSlidingPairsInput.value * GLASS_SLIDING_MATERIAL_PER_PAIR;
                const installCost = prices.glassSlidingInstallCost;
                
                addConstHtml += `<div class="list-item"><span>글라스 슬라이딩 ${glassSlidingPairsInput.value}짝 (자재+시공)</span><span>+ ${formatKRW(prices.glassSlidingTotal)}</span></div>`;
                addConstHtml += `<div class="list-item text-xs ml-2"><span>- (자재: ${formatKRW(materialCost)}, 시공: ${formatKRW(installCost)}${installCost === GLASS_SLIDING_INSTALL_MIN_FEE ? ' - 최소 시공비 적용' : ''})</span><span></span></div>`;
                additionalTotal += prices.glassSlidingTotal;
            }
            
            // 4.3. 데크
            if (deckAreaInput.value > 0) {
                addConstHtml += `<div class="list-item"><span>데크 추가 공사 ${deckAreaInput.value}m² (합성목 기준)</span><span>+ ${formatKRW(prices.deckTotal)}</span></div>`;
                additionalTotal += prices.deckTotal;
            }

            // 4.4. 기타 공사
            if (otherConstructionPrice.value > 0) {
                addConstHtml += `<div class="list-item"><span>기타 공사: ${otherConstructionName.value || '항목명 미기재'}</span><span>+ ${formatKRW(prices.otherPrice)}</span></div>`;
                additionalTotal += prices.otherPrice;
            }
            
            additionalConstructionList.innerHTML = addConstHtml || '<div class="list-item text-gray-500">선택된 추가 공사 항목 없음</div>';
            reportAdditionalTotal.textContent = formatKRW(additionalTotal);


            // --- 5. GRAND TOTAL ---
            // reportGrandTotalOutput.textContent = formatKRW(prices.totalCost); // 이제 헤더에서 업데이트됨
        }

        
        /**
         * 버튼 클릭 시 유효성 검사 및 견적 계산/전송
         */
        function handleQuoteRequest(event) {
            event.preventDefault();
            
            // 1. 필수 선택/입력값 유효성 검사
            const quantity = parseInt(quantityInput.value) || 0;
            // 전화번호 입력은 이제 선택 사항이며, 견적 산출을 막지 않음
            
            if (!spanInput.value.trim() || !pivotSelect.value || !heightSelect.value || quantity < 1) {
                displayError("사이즈 (가로, 세로, 높이) 및 수량(최소 1개소)을 모두 선택/입력해 주세요.");
                return;
            }
            
            // 2. 모든 검사 통과 시, 요약 업데이트 및 가격 계산 실행
            updateSummary();
            const prices = calculatePrice();
            
            // 3. 견적 계산 성공 시, 견적 결과 영역 표시
            if (prices && prices.totalCost > 0) {
                 // 견적 결과 영역 표시
                 quotationResultArea.style.display = 'block';
                 // successMessageModal 제거로 인해 이 코드는 제거
                 // finalPriceDisplay.textContent = formatKRW(prices.totalCost);
                 // successMessageModal.style.display = 'block';
                 
                 // PDF 저장을 유도하는 print() 호출도 제거됨.
            }
        }
        
        /**
         * 이벤트 리스너 설정
         */
        function setupListeners() {
            // 입력 변경 시 요약만 업데이트
            const updateSummaryOnly = () => {
                const activeBtn = document.querySelector('.toggle-btn.active');
                if (activeBtn) {
                    currentOperation = activeBtn.dataset.operation;
                }
                
                // 추가 공사 항목 금액 디스플레이 업데이트 (견적서에 표시)
                const glassFixedArea = parseFloat(glassFixedAreaInput.value) || 0;
                glassFixedPriceDisplay.textContent = `+ ${formatKRW(glassFixedArea * (GLASS_FIXED_MATERIAL_PER_M2 + GLASS_FIXED_INSTALL_PER_M2))}`;
                
                const glassSlidingPairs = parseInt(glassSlidingPairsInput.value) || 0;
                let glassSlidingTotalCost = (GLASS_SLIDING_MATERIAL_PER_PAIR + GLASS_SLIDING_INSTALL_PER_PAIR) * glassSlidingPairs;

                // 시공비 최소 금액 로직을 UI 표시에는 반영하지 않으나, 총액에 반영될 것임을 안내
                if (glassSlidingPairs > 0 && (glassSlidingPairs * GLASS_SLIDING_INSTALL_PER_PAIR) < GLASS_SLIDING_INSTALL_MIN_FEE) {
                    // UI에는 최소 시공비가 포함될 수 있음을 * 로 표시
                    glassSlidingPriceDisplay.textContent = `+ ${formatKRW(glassSlidingTotalCost)}*`;
                } else {
                    glassSlidingPriceDisplay.textContent = `+ ${formatKRW(glassSlidingTotalCost)}`;
                }

                const deckArea = parseFloat(deckAreaInput.value) || 0;
                deckPriceDisplay.textContent = `+ ${formatKRW(deckArea * DECK_PER_M2)}`;

                const otherPrice = parseInt(otherConstructionPrice.value) || 0;
                otherConstructionPriceDisplay.textContent = `+ ${formatKRW(otherPrice)}`;

                updateSummary();
            }

            // 제품/옵션/사이즈/수량 변경 시
            modelSelect.addEventListener('change', updateSummaryOnly);
            spanInput.addEventListener('input', updateSummaryOnly);
            pivotSelect.addEventListener('change', updateSummaryOnly);
            heightSelect.addEventListener('change', updateSummaryOnly);
            quantityInput.addEventListener('input', updateSummaryOnly); 
            ledOptionCheckbox.addEventListener('change', updateSummaryOnly);

            // 공사 옵션 및 고객 정보 변경 시
            regionSelect.addEventListener('change', () => {
                updateCityOptions();
                updateSummaryOnly();
            });
            citySelect.addEventListener('change', updateSummaryOnly);
            addressInput.addEventListener('input', updateSummaryOnly); 
            phoneInput.addEventListener('input', updateSummaryOnly); // 전화번호 입력 시 고객명 업데이트
            constructionRequiredCheckbox.addEventListener('change', updateSummaryOnly); 
            liftingOptionCheckbox.addEventListener('change', updateSummaryOnly);
            foundationOptionCheckbox.addEventListener('change', updateSummaryOnly);
            measurementOptionCheckbox.addEventListener('change', updateSummaryOnly);

            // 추가 공사 희망 항목 변경 시 (NEW - Input fields)
            glassFixedAreaInput.addEventListener('input', updateSummaryOnly);
            glassSlidingPairsInput.addEventListener('input', updateSummaryOnly);
            deckAreaInput.addEventListener('input', updateSummaryOnly);
            otherConstructionName.addEventListener('input', updateSummaryOnly);
            otherConstructionPrice.addEventListener('input', updateSummaryOnly);


            // Operation Toggle Event
            operationToggle.addEventListener('click', (event) => {
                const button = event.target.closest('.toggle-btn');
                if (!button) return;

                Array.from(operationToggle.children).forEach(btn => {
                    btn.classList.remove('active');
                });
                button.classList.add('active');

                currentOperation = button.dataset.operation;
                updatePivotOptions(); // PIVOT 옵션 업데이트 및 요약 업데이트
            });
            
            // 최종 견적 버튼 클릭 이벤트
            getQuoteBtn.addEventListener('click', handleQuoteRequest);
        }

        // 초기화
        window.onload = () => {
            setupListeners();
            updatePivotOptions(); // 초기 수동(manual) 옵션 로드 및 요약 업데이트
            initRegionOptions(); // 지역 옵션 로드 및 시/군/구 초기화
            updateSummary(); // 초기 견적 정보 (날짜 등) 업데이트
        }

    </script>
</body>
</html>
